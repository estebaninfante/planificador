<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tiempo | Versión Final</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Estilos Personalizados -->
    <style>
        :root {
            --bg-primary: #111015;
            --bg-secondary: #1C1B22;
            --bg-tertiary: #2A2931;
            --text-primary: #F0F0F0;
            --text-secondary: #A0A0A0;
            --accent-primary: #8A5CF4;
            --accent-secondary: #6337B7;
            --border-color: #3A3942;
            --time-slot-height: 60px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            user-select: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #4F4E57; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6A6972; }

        /* --- Utilidades --- */
        .glassmorphism {
            background: rgba(28, 27, 34, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600;
            transition: all 0.2s ease; cursor: pointer; border: none;
        }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:hover { background-color: var(--accent-secondary); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #3A3942; }
        .btn-danger { background-color: #E53E3E; color: white; }
        .btn-danger:hover { background-color: #C53030; }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }

        /* --- Layout Principal --- */
        .main-grid {
            display: grid; grid-template-columns: 350px 1fr;
            gap: 1.5rem; padding: 1.5rem; height: calc(100vh - 80px);
        }

        /* --- Tareas --- */
        .task-card {
            padding: 1rem; border-radius: 0.5rem; background-color: var(--bg-secondary);
            border-left: 4px solid var(--task-color, var(--accent-primary));
            cursor: grab; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .task-card:not(.selected):hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .task-card.dragging { opacity: 0.5; transform: scale(0.95); }
        
        /* Estilos para modo de selección de tareas */
        .selection-mode .task-card {
            cursor: pointer;
        }
        .selection-mode .task-card:hover {
            background-color: var(--bg-tertiary);
        }
        .task-card.selected {
            background-color: var(--accent-secondary) !important;
            border-left-color: var(--accent-primary) !important;
            transform: translateY(0) !important;
            box-shadow: none !important;
        }
        .task-select-checkbox {
            min-width: 1.15rem; height: 1.15rem;
            border-radius: 0.25rem; border: 2px solid var(--border-color);
            background-color: var(--bg-tertiary);
            appearance: none; -webkit-appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .task-select-checkbox:checked {
            background-color: var(--accent-primary);
            border-color: var(--accent-secondary);
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }


        /* --- Calendario con CSS Grid --- */
        #calendar-grid-container {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr); 
            grid-template-rows: auto repeat(36, calc(var(--time-slot-height) / 2));
            position: relative;
        }
        #calendar.day-view #calendar-grid-container {
             grid-template-columns: 60px 1fr;
        }
        .day-header, .time-header {
            text-align: center; font-weight: 600;
            padding: 0.75rem 0.5rem; position: sticky; top: 0;
            background-color: var(--bg-secondary); z-index: 20;
        }
        .day-header.current-day { background-color: var(--accent-primary); color: white; }
        .time-slot {
            grid-column: 1; text-align: right; font-size: 0.75rem;
            color: var(--text-secondary); padding-right: 0.5rem;
            transform: translateY(-50%);
        }
        .grid-line {
            border-top: 1px solid var(--border-color);
        }
        .day-column {
            position: relative;
            border-left: 1px solid var(--border-color);
        }
        .calendar-event {
            position: absolute; background-color: var(--task-color, var(--accent-primary));
            color: white; border-radius: 0.375rem; padding: 0.2rem 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); border: 1px solid rgba(0,0,0,0.2);
            transition: top 0.1s, height 0.1s; overflow: hidden; z-index: 10;
            cursor: pointer; display: flex; flex-direction: column;
        }
        .calendar-event.dragging, .calendar-event.resizing {
            opacity: 0.7; z-index: 20; transition: none;
        }
        .resize-handle {
            position: absolute; left: 0; right: 0; height: 8px;
            cursor: ns-resize; z-index: 15;
        }
        .resize-handle.top { top: 0; }
        .resize-handle.bottom { bottom: 0; }
        .calendar-event-preview {
            position: absolute; background-color: rgba(138, 92, 244, 0.5);
            border: 1px dashed var(--accent-primary); border-radius: 0.375rem;
            z-index: 5; pointer-events: none;
        }
        .current-time-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-primary);
            z-index: 25; /* Higher than events */
        }
        .current-time-indicator::before {
            content: '';
            position: absolute;
            left: -5px;
            top: -4px;
            width: 12px;
            height: 12px;
            background-color: var(--accent-primary);
            border-radius: 50%;
        }


        /* --- Modal --- */
        .modal {
            position: fixed; z-index: 1000; inset: 0;
            background-color: rgba(0, 0, 0, 0.7); display: flex;
            align-items: center; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content-unified {
            width: 90%; max-width: 1050px; /* Ancho aumentado */
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .modal.visible .modal-content-unified { transform: scale(1); }
        .form-input, .form-select {
            background-color: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 0.5rem; padding: 0.75rem; width: 100%;
            color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(138, 92, 244, 0.3);
        }
        .form-column {
            max-height: 65vh; /* Altura máxima para la columna del formulario */
            overflow-y: auto; /* Scroll si el contenido excede la altura */
            padding-right: 1rem; /* Espacio para el scrollbar */
        }
        
        /* Recurrence Styles */
        .day-toggle-btn {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .day-toggle-btn.active {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        .recurrence-options {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease, max-height 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-primary);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }


        /* --- Notificaciones --- */
        #toast-container {
            position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 2000;
            display: flex; flex-direction: column; gap: 0.5rem;
        }
        .toast {
            padding: 1rem 1.5rem; border-radius: 0.5rem; color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4); opacity: 0;
            transform: translateX(100%); animation: slideIn 0.5s forwards;
        }
        .toast.success { background-color: #48BB78; }
        .toast.error { background-color: #E53E3E; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }

        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; height: auto; padding: 1rem; gap: 1rem; }
            .modal-content-unified { grid-template-columns: 1fr; max-height: 80vh; overflow-y: auto; }
        }
        @media (max-width: 480px) {
            .main-grid { padding: 0.5rem; }
            header { padding: 0 1rem; height: 60px; }
            .main-grid { height: calc(100vh - 60px); }
            .day-header .block { display: none; }
            #calendar-grid-container { grid-template-columns: 50px 1fr; }
            .time-slot { font-size: 0.65rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="h-20 px-6 flex items-center justify-between border-b border-gray-800">
        <div class="flex items-center gap-3">
            <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <h1 class="text-2xl font-bold text-white">Gestor de Tiempo</h1>
        </div>
        <div>
            <button id="go-to-today-btn" class="btn btn-secondary">Hoy</button>
        </div>
    </header>

    <!-- Contenido Principal -->
    <main class="main-grid">
        <!-- Columna Izquierda: Tareas -->
        <aside class="flex flex-col gap-6">
            <div class="flex items-center gap-2">
                <input type="text" id="quick-add-task-input" class="form-input flex-grow" placeholder="Añadir tarea rápida y presionar Enter">
                <button id="detailed-add-task-btn" class="btn btn-primary h-full" title="Añadir tarea detallada">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
            <div class="glassmorphism rounded-xl p-4 flex-grow flex flex-col">
                <div class="flex border-b border-gray-700 mb-4">
                    <button id="tasks-tab-btn" class="flex-1 pb-2 font-semibold border-b-2 border-purple-500 text-white">Tareas</button>
                    <button id="bulk-add-tab-btn" class="flex-1 pb-2 font-semibold border-b-2 border-transparent text-gray-400">Por Lote</button>
                </div>
                <div id="tasks-tab-content">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Tareas Pendientes</h2>
                        <div id="task-actions">
                            <button id="select-tasks-btn" title="Seleccionar tareas" class="text-gray-400 hover:text-white p-1 rounded-md transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                            </button>
                        </div>
                        <div id="select-mode-actions" class="hidden items-center gap-2">
                            <button id="delete-selected-btn" class="btn btn-danger btn-sm">Eliminar</button>
                            <button id="cancel-select-btn" class="btn btn-secondary btn-sm">Cancelar</button>
                        </div>
                    </div>
                    <div id="task-list" class="space-y-3 flex-grow overflow-y-auto pr-2"></div>
                </div>
                <div id="bulk-add-tab-content" class="hidden space-y-4 overflow-y-auto">
                    <h2 class="text-xl font-semibold">Añadir por Lote (JSON)</h2>
                    <div>
                        <p class="text-sm text-gray-400 mb-2">Pega un array de objetos JSON. Cada objeto representa una tarea y sus eventos programados.</p>
                        <h3 class="font-semibold mt-4 mb-1">Estructura del Objeto Tarea:</h3>
                        <ul class="text-xs text-gray-500 list-disc list-inside space-y-1">
                            <li><code>name</code>: (string, requerido) Nombre de la tarea.</li>
                            <li><code>priority</code>: (string, opcional) "Baja", "Media", "Alta".</li>
                            <li><code>type</code>: (string, opcional) "Clase", "Tarea", "Lectura", etc.</li>
                            <li><code>subjectCategory</code>: (string, opcional) "Programación", "Cálculo", etc.</li>
                            <li><code>color</code>: (string, opcional) Código hexadecimal del color (ej. "#8A5CF4").</li>
                            <li><code>notes</code>: (string, opcional) Notas adicionales.</li>
                            <li><code>events</code>: (array, requerido) Lista de eventos a programar para esta tarea.</li>
                        </ul>
                        <h3 class="font-semibold mt-4 mb-1">Estructura del Objeto Evento:</h3>
                         <ul class="text-xs text-gray-500 list-disc list-inside space-y-1">
                            <li><code>date</code>: (string, requerido) Fecha del evento en formato "YYYY-MM-DD".</li>
                            <li><code>startHour</code>: (string, requerido) Hora de inicio en formato "HH:MM".</li>
                            <li><code>endHour</code>: (string, requerido) Hora de fin en formato "HH:MM".</li>
                            <li><code>isRecurrent</code>: (boolean, opcional) `true` si el evento se repite.</li>
                            <li><code>repeatOn</code>: (array de números, opcional) Días de la semana (0=Domingo, 1=Lunes...).</li>
                            <li><code>repeatUntil</code>: (string, opcional) Fecha de fin de la recurrencia "YYYY-MM-DD".</li>
                        </ul>
                    </div>
                    <textarea id="bulk-json-input" class="form-input w-full h-40 text-xs" placeholder="[ ... ]"></textarea>
                    <button id="add-bulk-btn" class="btn btn-primary w-full">Añadir Tareas</button>
                </div>
            </div>
        </aside>

        <!-- Columna Derecha: Calendario -->
        <section class="glassmorphism rounded-xl p-4 flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <button id="prev-week-btn" class="btn btn-secondary !p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path></svg></button>
                    <button id="next-week-btn" class="btn btn-secondary !p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path></svg></button>
                </div>
                <span id="current-week-range" class="text-lg font-bold text-center"></span>
                <div class="flex items-center gap-2 bg-gray-800 p-1 rounded-lg">
                    <button id="day-view-btn" class="btn !bg-transparent !text-gray-300 px-3 py-1 text-sm">Día</button>
                    <button id="week-view-btn" class="btn !bg-transparent !text-gray-300 px-3 py-1 text-sm">Semana</button>
                </div>
            </div>
            <div id="calendar" class="relative flex-grow overflow-auto"></div>
        </section>
    </main>

    <!-- Modal Unificado -->
    <div id="unified-modal" class="modal">
        <div class="modal-content-unified glassmorphism rounded-xl p-8">
            <!-- Columna de Visualización -->
            <div class="flex flex-col">
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-4">
                        <div id="view-task-color-bar" class="w-2 h-16 rounded-full"></div>
                        <div>
                            <h2 id="view-task-name" class="text-3xl font-bold"></h2>
                            <p id="view-task-time" class="text-gray-400 text-lg"></p>
                        </div>
                    </div>
                </div>
                <div class="my-6 border-t border-gray-700"></div>
                <div class="space-y-4 text-lg">
                    <div class="flex items-center gap-4"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span id="view-task-category"></span></div>
                    <div class="flex items-center gap-4"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h2zM7 13h10M7 17h5"></path></svg><span id="view-task-type"></span></div>
                    <div class="flex items-center gap-4"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg><span id="view-task-priority"></span></div>
                    <div class="flex items-start gap-4"><svg class="w-6 h-6 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7"></path></svg><p id="view-task-notes" class="text-gray-300 whitespace-pre-wrap"></p></div>
                </div>
            </div>

            <!-- Columna de Edición -->
            <div class="border-l border-gray-700 pl-8">
                <form id="task-form" class="space-y-5 form-column">
                    <div class="flex justify-between items-center">
                        <h2 id="modal-title" class="text-2xl font-bold">Añadir Tarea</h2>
                        <button type="button" class="close-modal-btn text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                    <input type="hidden" id="task-id"><input type="hidden" id="task-instance-id"><input type="hidden" id="new-event-date">
                    <div><label for="task-name" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label><input type="text" id="task-name" class="form-input" required></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="task-priority" class="block text-sm font-medium text-gray-300 mb-1">Prioridad</label><select id="task-priority" class="form-select"></select></div>
                        <div><label for="task-type" class="block text-sm font-medium text-gray-300 mb-1">Tipo</label><select id="task-type" class="form-select"></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="task-subject-category" class="block text-sm font-medium text-gray-300 mb-1">Categoría</label><select id="task-subject-category" class="form-select"></select></div>
                        <div><label for="task-color" class="block text-sm font-medium text-gray-300 mb-1">Color</label><input type="color" id="task-color" class="form-input !p-1 h-12" value="#8A5CF4"></div>
                    </div>
                    <div><label for="task-notes" class="block text-sm font-medium text-gray-300 mb-1">Notas</label><textarea id="task-notes" class="form-input" rows="3"></textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="assign-start-hour" class="block text-sm font-medium text-gray-300 mb-1">Hora Inicio</label><select id="assign-start-hour" class="form-select"></select></div>
                        <div><label for="assign-end-hour" class="block text-sm font-medium text-gray-300 mb-1">Hora Fin</label><select id="assign-end-hour" class="form-select"></select></div>
                    </div>
                    <!-- Recurrence Section -->
                    <div class="space-y-3 pt-2">
                        <label class="flex items-center justify-between text-sm font-medium text-gray-300 cursor-pointer">
                            <span>Evento Recurrente</span>
                            <div class="toggle-switch">
                                <input type="checkbox" id="task-recurrent" class="hidden">
                                <span class="toggle-slider"></span>
                            </div>
                        </label>
                        <div class="recurrence-options space-y-3">
                            <div class="flex justify-between" id="day-toggle-buttons">
                                <button type="button" class="day-toggle-btn" data-day="1">L</button>
                                <button type="button" class="day-toggle-btn" data-day="2">M</button>
                                <button type="button" class="day-toggle-btn" data-day="3">X</button>
                                <button type="button" class="day-toggle-btn" data-day="4">J</button>
                                <button type="button" class="day-toggle-btn" data-day="5">V</button>
                                <button type="button" class="day-toggle-btn" data-day="6">S</button>
                                <button type="button" class="day-toggle-btn" data-day="0">D</button>
                            </div>
                            <div>
                                <label for="task-repeat-until" class="block text-sm font-medium text-gray-300 mb-1">Repetir hasta</label>
                                <input type="date" id="task-repeat-until" class="form-input">
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-4">
                        <button type="button" id="delete-task-btn" class="btn btn-danger">Eliminar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURACIÓN Y ESTADO ---
        const STORAGE_KEYS = { tasks: 'timeManager_tasks_v4', schedule: 'timeManager_schedule_v4' };
        const getFromStorage = (key, def) => { try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; } };
        const saveToStorage = (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch (e) { console.error(e); } };
        
        let tasks = getFromStorage(STORAGE_KEYS.tasks, []);
        let scheduledTasks = getFromStorage(STORAGE_KEYS.schedule, {});
        let currentWeekStart = getStartOfWeek(new Date());
        let currentView = 'week';
        let isSelectModeActive = false;
        let selectedTaskIds = new Set();

        // --- REFERENCIAS AL DOM (simplificado) ---
        const dom = new Proxy({}, { get: (_, prop) => document.getElementById(prop) });
        
        // --- FUNCIONES AUXILIARES ---
        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        function getStartOfWeek(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setHours(0, 0, 0, 0);
            return new Date(date.setDate(diff));
        }
        const debounce = (func, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; };
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            dom['toast-container'].appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        const varToNumber = (name) => parseFloat(getComputedStyle(document.documentElement).getPropertyValue(name));

        // --- RENDERIZADO ---
        function renderTasks() {
            dom['task-list'].innerHTML = tasks.length === 0 ? `<p class="text-center text-gray-500 mt-8">No hay tareas pendientes.</p>` : '';
            dom['task-list'].classList.toggle('selection-mode', isSelectModeActive);

            tasks.forEach(task => {
                const div = document.createElement('div');
                div.className = 'task-card';
                div.dataset.taskId = task.id;
                div.style.setProperty('--task-color', task.color);

                let innerHTML;
                if (isSelectModeActive) {
                    const isChecked = selectedTaskIds.has(task.id);
                    div.classList.toggle('selected', isChecked);
                    innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" data-task-id="${task.id}" class="task-select-checkbox" ${isChecked ? 'checked' : ''}>
                            <div class="flex-grow">
                                <p class="font-semibold truncate">${task.name}</p>
                                <p class="text-sm text-gray-400">${task.subjectCategory}</p>
                            </div>
                        </div>`;
                } else {
                    innerHTML = `
                        <p class="font-semibold truncate">${task.name}</p>
                        <p class="text-sm text-gray-400">${task.subjectCategory}</p>`;
                }
                div.innerHTML = innerHTML;
                
                if (isSelectModeActive) {
                    div.addEventListener('click', (e) => {
                        const checkbox = div.querySelector('.task-select-checkbox');
                        if (e.target !== checkbox) {
                           checkbox.checked = !checkbox.checked;
                        }
                        const event = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(event);
                    });

                    const checkbox = div.querySelector('.task-select-checkbox');
                    checkbox.addEventListener('change', (e) => {
                        const id = e.target.dataset.taskId;
                        if (e.target.checked) {
                            selectedTaskIds.add(id);
                        } else {
                            selectedTaskIds.delete(id);
                        }
                        div.classList.toggle('selected', e.target.checked);
                    });
                } else {
                    div.draggable = true;
                    div.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', task.id); e.currentTarget.classList.add('dragging'); });
                    div.addEventListener('dragend', e => e.currentTarget.classList.remove('dragging'));
                    div.addEventListener('click', () => openUnifiedModal(task.id));
                }
                dom['task-list'].appendChild(div);
            });
        }

        function renderCalendar() {
            const isMobile = window.innerWidth < 768;
            const WEEKDAYS = isMobile ? ["L", "M", "X", "J", "V", "S", "D"] : ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
            const weekDates = Array.from({ length: 7 }, (_, i) => new Date(new Date(currentWeekStart).setDate(currentWeekStart.getDate() + i)));
            const daysToShow = currentView === 'day' ? [new Date()] : weekDates;
            
            dom['current-week-range'].textContent = `${weekDates[0].toLocaleDateString('es-ES', {day:'numeric', month:'long'})} - ${weekDates[6].toLocaleDateString('es-ES', {day:'numeric', month:'long', year:'numeric'})}`;
            
            let gridHtml = `<div id="calendar-grid-container">`;
            gridHtml += '<div class="time-header"></div>';
            daysToShow.forEach(date => {
                const isToday = date.toDateString() === new Date().toDateString();
                gridHtml += `<div class="day-header ${isToday ? 'current-day' : ''}">${WEEKDAYS[date.getDay() === 0 ? 6 : date.getDay() - 1]} <span class="block text-xs font-normal">${date.getDate()}</span></div>`;
            });
            for (let i = 0; i < 36; i++) {
                const hour = 6 + Math.floor(i / 2);
                if (i % 2 === 0) {
                    gridHtml += `<div class="time-slot" style="grid-row: ${i + 2}">${hour}:00</div>`;
                }
                const row = i + 2;
                gridHtml += `<div class="grid-line" style="grid-row: ${row}; grid-column: 2 / span ${daysToShow.length};"></div>`;
            }
            daysToShow.forEach((date, index) => {
                gridHtml += `<div class="day-column" data-date="${date.toISOString().slice(0, 10)}" style="grid-column: ${index + 2}; grid-row: 2 / span 36;"></div>`;
            });
            gridHtml += '</div>';
            dom.calendar.innerHTML = gridHtml;
            if (currentView === 'day') {
                dom.calendar.classList.add('day-view');
            } else {
                dom.calendar.classList.remove('day-view');
            }
            
            setTimeout(() => {
                renderScheduledTasks(daysToShow);
                setupCalendarInteractions();
                renderCurrentTimeIndicator();
            }, 0);
        }

        function renderScheduledTasks(daysToShow) {
            const container = dom.calendar.querySelector('#calendar-grid-container');
            if (!container) return;
            daysToShow.forEach((date) => {
                const dateStr = date.toISOString().slice(0, 10);
                const column = container.querySelector(`.day-column[data-date="${dateStr}"]`);
                if (!column) return;
                
                let dailyEvents = Object.entries(scheduledTasks)
                    .filter(([, event]) => event.date === dateStr)
                    .map(([instanceId, event]) => {
                        const task = tasks.find(t => t.id === event.taskId) || { name: 'Tarea eliminada', color: '#E53E3E' };
                        const [startH, startM] = event.startHour.split(':').map(Number);
                        const [endH, endM] = event.endHour.split(':').map(Number);
                        return { ...event, instanceId, name: task.name, color: task.color, start: startH + startM / 60, end: endH + endM / 60 };
                    })
                    .sort((a, b) => a.start - b.start);

                const eventLevels = [];
                dailyEvents.forEach(event => {
                    let placed = false;
                    for (let i = 0; i < eventLevels.length; i++) {
                        if (!eventLevels[i].some(e2 => event.start < e2.end && event.end > e2.start)) {
                            eventLevels[i].push(event); event.level = i; placed = true; break;
                        }
                    }
                    if (!placed) { event.level = eventLevels.length; eventLevels.push([event]); }
                });
                const totalLevels = Math.max(1, eventLevels.length);

                dailyEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'calendar-event';
                    eventDiv.dataset.instanceId = event.instanceId;
                    eventDiv.style.setProperty('--task-color', event.color);
                    
                    const top = (event.start - 6) * varToNumber('--time-slot-height');
                    const height = (event.end - event.start) * varToNumber('--time-slot-height');
                    const eventGroupWidth = 100 / totalLevels;
                    const left = event.level * eventGroupWidth;

                    eventDiv.style.top = `${top}px`;
                    eventDiv.style.height = `${height}px`;
                    eventDiv.style.left = `${left}%`;
                    eventDiv.style.width = `${eventGroupWidth}%`;

                    eventDiv.innerHTML = `<div class="font-semibold text-xs truncate">${event.name}</div><div class="text-xs">${event.startHour} - ${event.endHour}</div><div class="resize-handle top"></div><div class="resize-handle bottom"></div>`;
                    column.appendChild(eventDiv);
                });
            });
        }

        function renderCurrentTimeIndicator() {
            const existingIndicator = dom.calendar.querySelector('.current-time-indicator');
            if (existingIndicator) existingIndicator.remove();

            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            const column = dom.calendar.querySelector(`.day-column[data-date="${todayStr}"]`);

            if (column) { 
                const hourHeight = varToNumber('--time-slot-height');
                const minutesSince6AM = (now.getHours() * 60 + now.getMinutes()) - (6 * 60);
                
                if (minutesSince6AM >= 0 && minutesSince6AM <= 18 * 60) {
                    const topPosition = (minutesSince6AM / 60) * hourHeight;
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'current-time-indicator';
                    indicator.style.top = `${topPosition}px`;
                    
                    column.appendChild(indicator);
                }
            }
        }
        
        // --- INTERACCIONES Y MODALES ---
        function setupCalendarInteractions() {
            const container = dom.calendar.querySelector('#calendar-grid-container');
            if (!container) return;
            
            container.querySelectorAll('.day-column').forEach(column => {
                column.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'rgba(138, 92, 244, 0.2)'; });
                column.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                column.addEventListener('drop', e => {
                    e.preventDefault();
                    e.currentTarget.style.backgroundColor = '';
                    const taskId = e.dataTransfer.getData('text/plain');
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return;

                    const rect = e.currentTarget.getBoundingClientRect();
                    const hourHeight = varToNumber('--time-slot-height');
                    const hour = 6 + (e.clientY - rect.top) / hourHeight;
                    const startHour = Math.floor(hour) + (Math.round((hour % 1) * 2) / 2);
                    const format = h => `${String(Math.floor(h)).padStart(2,'0')}:${String((h%1)*60).padStart(2,'0')}`;

                    const newInstance = { taskId: task.id, date: column.dataset.date, startHour: format(startHour), endHour: format(startHour + 1) };
                    scheduledTasks[generateId()] = newInstance;
                    saveToStorage(STORAGE_KEYS.schedule, scheduledTasks);
                    renderAll();
                    showToast('Tarea programada');
                });
            });

            let draggedEl, resizeMode, isCreating, createPreviewEl;
            let initialY, initialTop, initialHeight, initialMouseX;
            let startColumn;

            const onMouseMove = (e) => {
                const hourHeight = varToNumber('--time-slot-height');
                const gridStep = hourHeight / 2;
                if (isCreating) {
                    if (!createPreviewEl) return;
                    const dy = e.clientY - initialY;
                    const newHeight = Math.max(gridStep, Math.round((initialHeight + dy) / gridStep) * gridStep);
                    createPreviewEl.style.height = `${newHeight}px`;
                } else if (draggedEl) {
                    const dy = e.clientY - initialY;
                    if (resizeMode === 'start') {
                        const newTop = Math.round((initialTop + dy) / gridStep) * gridStep;
                        draggedEl.style.top = `${newTop}px`;
                        draggedEl.style.height = `${initialHeight - (newTop - initialTop)}px`;
                    } else if (resizeMode === 'end') {
                        draggedEl.style.height = `${Math.max(gridStep, Math.round((initialHeight + dy) / gridStep) * gridStep)}px`;
                    } else { // Mover
                        const dx = e.clientX - initialMouseX;
                        draggedEl.style.transform = `translate(${dx}px, ${dy}px)`;
                    }
                }
            };

            const onMouseUp = (e) => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);

                if (isCreating) {
                    if (createPreviewEl) {
                        const hourHeight = varToNumber('--time-slot-height');
                        const startHour = 6 + (createPreviewEl.offsetTop / hourHeight);
                        const endHour = startHour + (createPreviewEl.offsetHeight / hourHeight);
                        const format = h => `${String(Math.floor(h)).padStart(2,'0')}:${String(Math.round((h%1)*60)).padStart(2,'0')}`;
                        createPreviewEl.remove();
                        openUnifiedModal(null, null, { date: startColumn.dataset.date, startHour: format(startHour), endHour: format(endHour) });
                    }
                } else if (draggedEl) {
                    const instanceId = draggedEl.dataset.instanceId;
                    const eventData = scheduledTasks[instanceId];
                    const dx = e.clientX - initialMouseX;
                    const dy = e.clientY - initialY;
                    const distance = Math.sqrt(dx*dx + dy*dy);

                    if (distance < 5 && !resizeMode) { // Es un clic
                        openUnifiedModal(eventData.taskId, instanceId);
                    } else if (eventData) { // Es un drag o resize
                        draggedEl.style.transform = 'translate(0,0)';
                        const hourHeight = varToNumber('--time-slot-height');
                        const gridStep = hourHeight / 2;
                        const format = h => `${String(Math.floor(h)).padStart(2,'0')}:${String(Math.round((h%1)*60)).padStart(2,'0')}`;

                        if (resizeMode) {
                            const finalTop = draggedEl.offsetTop;
                            const finalHeight = draggedEl.offsetHeight;
                            eventData.startHour = format(6 + (finalTop / hourHeight));
                            eventData.endHour = format(6 + (finalTop + finalHeight) / hourHeight);
                        } else {
                            const columns = Array.from(container.querySelectorAll('.day-column'));
                            const rects = columns.map(c => c.getBoundingClientRect());
                            const mouseX = e.clientX;
                            
                            let dayIndex = rects.findIndex(rect => mouseX >= rect.left && mouseX < rect.right);
                            if (dayIndex === -1) dayIndex = 0;

                            const column = columns[dayIndex];
                            
                            const finalTop = initialTop + dy;
                            const snappedTop = Math.round(finalTop / gridStep) * gridStep;
                            
                            const newStartHour = 6 + (snappedTop / hourHeight);
                            const eventDuration = (new Date(`1970-01-01T${eventData.endHour}`) - new Date(`1970-01-01T${eventData.startHour}`)) / 3600000;
                            const newEndHour = newStartHour + eventDuration;
                            
                            eventData.startHour = format(newStartHour);
                            eventData.endHour = format(newEndHour);
                            eventData.date = column.dataset.date;
                        }
                        
                        saveToStorage(STORAGE_KEYS.schedule, scheduledTasks);
                    }
                    draggedEl.classList.remove('dragging', 'resizing');
                }
                draggedEl = null;
                isCreating = false;
                resizeMode = null;
                renderCalendar();
            };
            
            container.querySelectorAll('.day-column').forEach(column => {
                column.addEventListener('mousedown', e => {
                    if (e.button !== 0 || e.target.closest('.calendar-event')) return;

                    isCreating = true;
                    startColumn = column;
                    const rect = column.getBoundingClientRect();
                    
                    const hourHeight = varToNumber('--time-slot-height');
                    const gridStep = hourHeight / 2;
                    const relativeMouseY = e.clientY - rect.top;
                    
                    initialTop = Math.floor(relativeMouseY / gridStep) * gridStep;
                    
                    createPreviewEl = document.createElement('div');
                    createPreviewEl.className = 'calendar-event-preview';
                    createPreviewEl.style.top = `${initialTop}px`;
                    createPreviewEl.style.left = `0px`;
                    createPreviewEl.style.width = `100%`;
                    createPreviewEl.style.height = `${gridStep}px`;
                    
                    column.appendChild(createPreviewEl);
                    initialY = e.clientY;
                    initialHeight = gridStep;
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });

            container.querySelectorAll('.calendar-event').forEach(el => {
                el.addEventListener('mousedown', e => {
                    if (e.button !== 0) return;
                    e.stopPropagation();
                    isCreating = false;
                    draggedEl = el;
                    initialY = e.clientY;
                    initialMouseX = e.clientX;
                    initialTop = draggedEl.offsetTop;
                    if (e.target.classList.contains('resize-handle')) {
                        resizeMode = e.target.classList.contains('top') ? 'start' : 'end';
                        initialHeight = draggedEl.offsetHeight;
                        draggedEl.classList.add('resizing');
                    } else {
                        resizeMode = null;
                        draggedEl.classList.add('dragging');
                    }
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });
        }

        function openUnifiedModal(taskId = null, instanceId = null, defaults = {}) {
            dom['task-form'].reset();
            const isEditing = !!taskId;
            const task = isEditing ? tasks.find(t => t.id === taskId) : {};
            const event = instanceId ? scheduledTasks[instanceId] : {};

            // Populate View Column
            dom['view-task-color-bar'].style.backgroundColor = task?.color || '#8A5CF4';
            dom['view-task-name'].textContent = defaults.name || task?.name || 'Nueva Tarea';
            const eventDateStr = defaults.date || event?.date || new Date().toISOString().slice(0,10);
            const eventDate = new Date(eventDateStr + 'T00:00:00');
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const startTime = defaults.startHour || event?.startHour || '';
            const endTime = defaults.endHour || event?.endHour || '';
            dom['view-task-time'].textContent = `${eventDate.toLocaleDateString('es-ES', dateOptions)} • ${startTime} - ${endTime}`;
            dom['view-task-category'].textContent = task?.subjectCategory || 'General';
            dom['view-task-type'].textContent = task?.type || 'Otro';
            dom['view-task-priority'].textContent = task?.priority || 'Media';
            dom['view-task-notes'].textContent = task?.notes || 'No hay notas.';

            // Populate Edit Column
            dom['modal-title'].textContent = isEditing ? 'Editar Tarea' : 'Añadir Tarea';
            dom['task-id'].value = isEditing ? taskId : '';
            dom['task-instance-id'].value = instanceId || '';
            dom['new-event-date'].value = eventDateStr; // Store date for new events
            dom['task-name'].value = defaults.name || task?.name || '';
            dom['task-priority'].value = task?.priority || 'Media';
            dom['task-type'].value = task?.type || 'Otro';
            dom['task-subject-category'].value = task?.subjectCategory || 'General';
            dom['task-color'].value = task?.color || '#8A5CF4';
            dom['task-notes'].value = task?.notes || '';
            dom['assign-start-hour'].value = startTime;
            dom['assign-end-hour'].value = endTime;
            dom['delete-task-btn'].style.display = isEditing ? 'flex' : 'none';
            
            // Populate Recurrence
            dom['task-recurrent'].checked = task?.isRecurrent || false;
            const recurrenceOptions = document.querySelector('.recurrence-options');
            if (task?.isRecurrent) {
                recurrenceOptions.style.display = 'block';
                setTimeout(() => {
                    recurrenceOptions.style.maxHeight = '200px';
                    recurrenceOptions.style.opacity = '1';
                }, 10);
            } else {
                recurrenceOptions.style.maxHeight = '0';
                recurrenceOptions.style.opacity = '0';
                setTimeout(() => {
                    if (!dom['task-recurrent'].checked) {
                        recurrenceOptions.style.display = 'none';
                    }
                }, 300);
            }
            document.querySelectorAll('.day-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
                if (task?.repeatOn?.includes(parseInt(btn.dataset.day))) {
                    btn.classList.add('active');
                }
            });
            dom['task-repeat-until'].value = task?.repeatUntil || '';

            dom['unified-modal'].classList.add('visible');
        }

        // --- MANEJO DE SELECCIÓN MÚLTIPLE ---
        function toggleSelectMode(forceOff = false) {
            isSelectModeActive = forceOff ? false : !isSelectModeActive;
            
            if (!isSelectModeActive) {
                selectedTaskIds.clear();
            }

            dom['task-actions'].classList.toggle('hidden', isSelectModeActive);
            dom['select-mode-actions'].classList.toggle('hidden', !isSelectModeActive);
            renderTasks();
        }

        function deleteSelectedTasks() {
            if (selectedTaskIds.size === 0) {
                showToast('No hay tareas seleccionadas', 'error');
                return;
            }
            if (!confirm(`¿Seguro que quieres eliminar ${selectedTaskIds.size} tarea(s) y todos sus eventos programados?`)) {
                return;
            }

            tasks = tasks.filter(t => !selectedTaskIds.has(t.id));
            Object.keys(scheduledTasks).forEach(key => {
                if (selectedTaskIds.has(scheduledTasks[key].taskId)) {
                    delete scheduledTasks[key];
                }
            });
            
            saveToStorage(STORAGE_KEYS.tasks, tasks);
            saveToStorage(STORAGE_KEYS.schedule, scheduledTasks);
            showToast(`${selectedTaskIds.size} tarea(s) eliminada(s)`, 'error');
            
            toggleSelectMode(true); // Forzar salida del modo selección
            renderCalendar(); // Actualizar calendario por si se borraron eventos
        }


        // --- INICIALIZACIÓN ---
        function renderAll() {
            renderTasks();
            renderCalendar();
        }

        function init() {
            const closeModalBtns = document.querySelectorAll('.close-modal-btn');

            // Listeners de selección múltiple
            dom['select-tasks-btn'].addEventListener('click', () => toggleSelectMode());
            dom['cancel-select-btn'].addEventListener('click', () => toggleSelectMode());
            dom['delete-selected-btn'].addEventListener('click', deleteSelectedTasks);

            dom['detailed-add-task-btn'].addEventListener('click', () => openUnifiedModal());
            dom['quick-add-task-input'].addEventListener('keyup', e => {
                if (e.key === 'Enter' && dom['quick-add-task-input'].value.trim()) {
                    const newTask = { id: generateId(), name: dom['quick-add-task-input'].value.trim(), priority: 'Media', type: 'Otro', subjectCategory: 'General', color: '#8A5CF4' };
                    tasks.push(newTask);
                    saveToStorage(STORAGE_KEYS.tasks, tasks);
                    renderTasks();
                    dom['quick-add-task-input'].value = '';
                    showToast('Tarea rápida añadida');
                }
            });
            
            const setupViewButtons = () => {
                const btns = { day: dom['day-view-btn'], week: dom['week-view-btn'] };
                Object.values(btns).forEach(b => b.classList.remove('bg-purple-600', 'text-white'));
                btns[currentView].classList.add('bg-purple-600', 'text-white');
            };
            dom['prev-week-btn'].addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() - (currentView === 'day' ? 1 : 7)); renderCalendar(); });
            dom['next-week-btn'].addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() + (currentView === 'day' ? 1 : 7)); renderCalendar(); });
            dom['day-view-btn'].addEventListener('click', () => { currentView = 'day'; renderCalendar(); setupViewButtons(); });
            dom['week-view-btn'].addEventListener('click', () => { currentView = 'week'; renderCalendar(); setupViewButtons(); });
            dom['go-to-today-btn'].addEventListener('click', () => { currentWeekStart = getStartOfWeek(new Date()); renderCalendar(); });
            window.addEventListener('resize', debounce(renderCalendar, 150));

            dom['task-form'].addEventListener('submit', e => {
                e.preventDefault();
                const id = dom['task-id'].value || generateId();
                const isUpdating = !!dom['task-id'].value;
                let task = isUpdating ? tasks.find(t => t.id === id) : { id };
                
                const isRecurrent = dom['task-recurrent'].checked;
                const repeatUntil = dom['task-repeat-until'].value;
                const repeatOn = Array.from(document.querySelectorAll('#day-toggle-buttons .active')).map(btn => parseInt(btn.dataset.day));

                Object.assign(task, {
                    name: dom['task-name'].value, priority: dom['task-priority'].value, type: dom['task-type'].value,
                    subjectCategory: dom['task-subject-category'].value, color: dom['task-color'].value, notes: dom['task-notes'].value,
                    isRecurrent, repeatOn, repeatUntil
                });
                if (!isUpdating) tasks.push(task);
                
                // Limpiar instancias viejas antes de crear nuevas
                Object.keys(scheduledTasks).forEach(key => {
                    if (scheduledTasks[key].taskId === id) {
                        delete scheduledTasks[key];
                    }
                });

                if (isRecurrent && repeatOn.length > 0 && repeatUntil) {
                    let currentDate = new Date(dom['new-event-date'].value + 'T00:00:00');
                    const endDate = new Date(repeatUntil + 'T00:00:00');
                    while(currentDate <= endDate) {
                        if (repeatOn.includes(currentDate.getDay())) {
                             scheduledTasks[generateId()] = {
                                taskId: id,
                                date: currentDate.toISOString().slice(0, 10),
                                startHour: dom['assign-start-hour'].value,
                                endHour: dom['assign-end-hour'].value
                            };
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                } else {
                    const instanceId = dom['task-instance-id'].value || generateId();
                    scheduledTasks[instanceId] = {
                        taskId: id,
                        date: dom['new-event-date'].value,
                        startHour: dom['assign-start-hour'].value,
                        endHour: dom['assign-end-hour'].value
                    };
                }

                saveToStorage(STORAGE_KEYS.tasks, tasks);
                saveToStorage(STORAGE_KEYS.schedule, scheduledTasks);
                dom['unified-modal'].classList.remove('visible');
                renderAll();
                showToast(isUpdating ? 'Tarea actualizada' : 'Tarea creada');
            });

            dom['delete-task-btn'].addEventListener('click', () => {
                if (!confirm('¿Seguro que quieres eliminar esta tarea y todos sus eventos programados?')) return;
                const id = dom['task-id'].value;
                tasks = tasks.filter(t => t.id !== id);
                Object.keys(scheduledTasks).forEach(key => {
                    if (scheduledTasks[key].taskId === id) delete scheduledTasks[key];
                });
                saveToStorage(STORAGE_KEYS.tasks, tasks);
                saveToStorage(STORAGE_KEYS.schedule, scheduledTasks);
                dom['unified-modal'].classList.remove('visible');
                renderAll();
                showToast('Tarea eliminada', 'error');
            });

            closeModalBtns.forEach(btn => btn.closest('.modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget || e.target.closest('.close-modal-btn')) {
                    e.currentTarget.classList.remove('visible');
                }
            }));
            
            dom['task-recurrent'].parentElement.parentElement.addEventListener('click', (e) => {
                const checkbox = dom['task-recurrent'];
                if (e.target.closest('.toggle-slider')) {
                    checkbox.checked = !checkbox.checked;
                }
                const optionsDiv = document.querySelector('.recurrence-options');
                if (checkbox.checked) {
                    optionsDiv.style.display = 'block';
                    setTimeout(() => {
                        optionsDiv.style.maxHeight = '200px';
                        optionsDiv.style.opacity = '1';
                    }, 10);
                } else {
                    optionsDiv.style.maxHeight = '0';
                    optionsDiv.style.opacity = '0';
                    setTimeout(() => {
                        if (!checkbox.checked) {
                            optionsDiv.style.display = 'none';
                        }
                    }, 300);
                }
            });

            document.querySelectorAll('.day-toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => btn.classList.toggle('active'));
            });

            // Tab switching
            dom['tasks-tab-btn'].addEventListener('click', () => {
                dom['tasks-tab-content'].classList.remove('hidden');
                dom['bulk-add-tab-content'].classList.add('hidden');
                dom['tasks-tab-btn'].classList.add('border-purple-500', 'text-white');
                dom['tasks-tab-btn'].classList.remove('border-transparent', 'text-gray-400');
                dom['bulk-add-tab-btn'].classList.add('border-transparent', 'text-gray-400');
                dom['bulk-add-tab-btn'].classList.remove('border-purple-500', 'text-white');
            });

            dom['bulk-add-tab-btn'].addEventListener('click', () => {
                dom['tasks-tab-content'].classList.add('hidden');
                dom['bulk-add-tab-content'].classList.remove('hidden');
                dom['bulk-add-tab-btn'].classList.add('border-purple-500', 'text-white');
                dom['bulk-add-tab-btn'].classList.remove('border-transparent', 'text-gray-400');
                dom['tasks-tab-btn'].classList.add('border-transparent', 'text-gray-400');
                dom['tasks-tab-btn'].classList.remove('border-purple-500', 'text-white');
            });

            // Bulk add logic
            dom['add-bulk-btn'].addEventListener('click', () => {
                const jsonInput = dom['bulk-json-input'].value;
                try {
                    const bulkTasks = JSON.parse(jsonInput);
                    if (!Array.isArray(bulkTasks)) {
                        throw new Error("El JSON debe ser un array de tareas.");
                    }

                    bulkTasks.forEach(taskData => {
                        const newTask = {
                            id: generateId(),
                            name: taskData.name,
                            priority: taskData.priority || 'Media',
                            type: taskData.type || 'Otro',
                            subjectCategory: taskData.subjectCategory || 'General',
                            color: taskData.color || '#8A5CF4',
                            notes: taskData.notes || '',
                        };
                        
                        if (Array.isArray(taskData.events)) {
                            taskData.events.forEach(eventData => {
                                if (eventData.isRecurrent && Array.isArray(eventData.repeatOn) && eventData.repeatUntil) {
                                    Object.assign(newTask, {isRecurrent: true, repeatOn: eventData.repeatOn, repeatUntil: eventData.repeatUntil});
                                    let currentDate = new Date(eventData.date + 'T00:00:00');
                                    const endDate = new Date(eventData.repeatUntil + 'T00:00:00');
                                    while(currentDate <= endDate) {
                                        if (eventData.repeatOn.includes(currentDate.getDay())) {
                                            scheduledTasks[generateId()] = { taskId: newTask.id, date: currentDate.toISOString().slice(0, 10), startHour: eventData.startHour, endHour: eventData.endHour };
                                        }
                                        currentDate.setDate(currentDate.getDate() + 1);
                                    }
                                } else {
                                    scheduledTasks[generateId()] = { taskId: newTask.id, date: eventData.date, startHour: eventData.startHour, endHour: eventData.endHour };
                                }
                            });
                        }
                        tasks.push(newTask);
                    });

                    saveToStorage(STORAGE_KEYS.tasks, tasks);
                    saveToStorage(STORAGE_KEYS.schedule, scheduledTasks);
                    renderAll();
                    showToast(`${bulkTasks.length} tareas añadidas correctamente.`);
                    dom['bulk-json-input'].value = '';
                } catch (error) {
                    showToast(`Error en el formato JSON: ${error.message}`, 'error');
                }
            });


            const options = {
                priority: ['Baja', 'Media', 'Alta'],
                type: ['Otro', 'Clase', 'Tarea', 'Lectura', 'Examen', 'Personal'],
                subjectCategory: ['General', 'Cálculo', 'Programación', 'Historia', 'Arte', 'Deportes'],
                time: Array.from({length:36}, (_,i) => `${String(Math.floor(6+i/2)).padStart(2,'0')}:${String((i%2)*30).padStart(2,'0')}`)
            };
            const populate = (sel, opts, def) => { sel.innerHTML = `<option value="">${def}</option>` + opts.map(o => `<option value="${o}">${o}</option>`).join(''); };
            populate(dom['task-priority'], options.priority, 'Prioridad');
            populate(dom['task-type'], options.type, 'Tipo');
            populate(dom['task-subject-category'], options.subjectCategory, 'Categoría');
            populate(dom['assign-start-hour'], options.time, 'Inicio');
            populate(dom['assign-end-hour'], options.time, 'Fin');

            if (tasks.length === 0 && Object.keys(scheduledTasks).length === 0) {
                const sample1 = { id: generateId(), name: 'Diseñar UI de la App', priority: 'Alta', type: 'Tarea', subjectCategory: 'Programación', color: '#8A5CF4', notes: 'Usar Figma para los mockups.\nRevisar la paleta de colores del brandbook.' };
                const sample2 = { id: generateId(), name: 'Reunión de equipo', priority: 'Media', type: 'Otro', subjectCategory: 'General', color: '#38bdf8', notes: 'Discutir avances del sprint.' };
                tasks.push(sample1, sample2);
                const today = new Date();
                const todayStr = today.toISOString().slice(0, 10);
                scheduledTasks[generateId()] = { taskId: sample1.id, date: todayStr, startHour: '10:00', endHour: '12:30' };
                scheduledTasks[generateId()] = { taskId: sample2.id, date: todayStr, startHour: '14:00', endHour: '15:00' };
                saveToStorage(STORAGE_KEYS.tasks, tasks);
                saveToStorage(STORAGE_KEYS.schedule, scheduledTasks);
            }

            setupViewButtons();
            renderAll();
            setInterval(renderCurrentTimeIndicator, 60000); // Update every minute
        }

        init();
    });
    </script>
</body>
</html>
