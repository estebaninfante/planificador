<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tiempo | Versión Final</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <!-- Estilos Personalizados -->
    <style>
        :root {
            --bg-primary: #111015;
            --bg-secondary: #1C1B22;
            --bg-tertiary: #2A2931;
            --text-primary: #F0F0F0;
            --text-secondary: #A0A0A0;
            --accent-primary: #8A5CF4;
            --accent-secondary: #6337B7;
            --border-color: #3A3942;
            --time-slot-height: 60px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #4F4E57; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6A6972; }

        /* --- Utilidades --- */
        .glassmorphism {
            background: rgba(28, 27, 34, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600;
            transition: all 0.2s ease; cursor: pointer; border: none;
        }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:hover { background-color: var(--accent-secondary); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #3A3942; }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }
        .icon-btn {
            background: none; border: none; color: var(--text-secondary);
            padding: 0.25rem; border-radius: 0.375rem;
            transition: color 0.2s, background-color 0.2s;
        }
        .icon-btn:hover {
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
        }

        /* --- Layout Principal --- */
        #main-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            height: calc(100vh - 80px); /* Header is 80px tall (h-20) */
        }

        .sidebar-scroll-container {
            flex-grow: 1;
            min-height: 0; /* Crucial for flexbox scrolling */
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) var(--bg-secondary);
        }

        /* --- Tareas y Subtareas --- */
        .task-card {
            padding: 1rem; border-radius: 0.5rem; background-color: var(--bg-secondary);
            border-left: 4px solid var(--task-color, var(--accent-primary));
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .task-card:not(.selection-mode):not(.no-hover):hover { 
             transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        .task-card .task-header { cursor: pointer; }
        .task-card.dragging { opacity: 0.5; transform: scale(0.95); }

        .subtask-list {
            border-top: 1px solid var(--border-color);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
        }
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            cursor: grab;
        }
        .subtask-item.completed span {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        .subtask-item.dragging {
            opacity: 0.5;
            background-color: var(--bg-tertiary);
        }
        .drag-over-area {
            background-color: rgba(138, 92, 244, 0.1);
            border: 1px dashed var(--accent-primary);
        }
        .selection-mode .task-card {
            cursor: pointer;
        }
        .selection-mode .task-card:hover {
            background-color: var(--bg-tertiary);
        }
        .task-card.selected {
            background-color: var(--accent-secondary) !important;
            border-left-color: var(--accent-primary) !important;
        }
        .task-select-checkbox {
            min-width: 1.15rem; height: 1.15rem;
            border-radius: 0.25rem; border: 2px solid var(--border-color);
            background-color: var(--bg-tertiary);
            appearance: none; -webkit-appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .task-select-checkbox:checked {
            background-color: var(--accent-primary);
            border-color: var(--accent-secondary);
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        
        /* --- Calendario con CSS Grid --- */
        #calendar-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr); 
            grid-template-rows: auto repeat(48, calc(var(--time-slot-height) / 2));
            position: relative;
        }
        #calendar-grid.day-view {
             grid-template-columns: 60px 1fr;
        }
        .day-header, .time-header {
            text-align: center; font-weight: 600;
            padding: 0.75rem 0.5rem; position: sticky; top: 0;
            background-color: var(--bg-secondary); z-index: 20;
        }
        .day-header.current-day { background-color: var(--accent-primary); color: white; }
        .time-slot {
            grid-column: 1; text-align: right; font-size: 0.75rem;
            color: var(--text-secondary); padding-right: 0.5rem;
            transform: translateY(-50%);
        }
        .grid-line {
            border-top: 1px solid var(--border-color);
        }
        .day-column {
            position: relative;
            border-left: 1px solid var(--border-color);
        }
        .calendar-event {
            position: absolute; background-color: var(--task-color, var(--accent-primary));
            color: white; border-radius: 0.375rem; padding: 0.2rem 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); border: 1px solid rgba(0,0,0,0.2);
            transition: top 0.1s, height 0.1s; overflow: hidden; z-index: 10;
            cursor: pointer; display: flex; flex-direction: column;
        }
        .calendar-event.dragging, .calendar-event.resizing {
            opacity: 0.7; z-index: 20; transition: none;
        }
        .resize-handle {
            position: absolute; left: 0; right: 0; height: 8px;
            cursor: ns-resize; z-index: 15;
        }
        .resize-handle.top { top: 0; }
        .resize-handle.bottom { bottom: 0; }
        .calendar-event-preview {
            position: absolute; background-color: rgba(138, 92, 244, 0.5);
            border: 1px dashed var(--accent-primary); border-radius: 0.375rem;
            z-index: 5; pointer-events: none;
        }
        .current-time-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-primary);
            z-index: 25;
        }
        .current-time-indicator::before {
            content: '';
            position: absolute;
            left: -5px;
            top: -4px;
            width: 12px;
            height: 12px;
            background-color: var(--accent-primary);
            border-radius: 50%;
        }

        /* --- Sección de Estadísticas --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            padding: 1.5rem;
        }
        .stat-card {
            padding: 1.5rem;
        }
        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        /* --- Modal --- */
        .modal {
            position: fixed; z-index: 1000; inset: 0;
            background-color: rgba(0, 0, 0, 0.7); display: flex;
            align-items: center; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content-unified {
            width: 90%; max-width: 1050px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .modal-content-choice {
            position: relative;
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal.visible .modal-content-unified,
        .modal.visible .modal-content-choice { transform: scale(1); }
        
        .form-input, .form-select, .notes-editor {
            background-color: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 0.5rem; padding: 0.75rem; width: 100%;
            color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s;
        }
        .notes-title-input {
            background: transparent;
            border: none;
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 2.5rem;
            padding: 0;
            width: 100%;
        }
         .notes-title-input:focus {
            outline: none;
            box-shadow: none;
        }

        .form-input:focus, .form-select:focus, .notes-editor:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(138, 92, 244, 0.3);
        }
        .form-column {
            max-height: 65vh;
            overflow-y: auto;
            padding-right: 1rem;
        }

        /* Popover */
        .popover {
            position: absolute;
            z-index: 100;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
        }
        
        /* Notebook view */
        #notebook-fullscreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 2000;
        }
        .prose-invert {
             --tw-prose-body: var(--text-primary);
             --tw-prose-headings: white;
             --tw-prose-lead: #a1a1aa;
             --tw-prose-links: #d4d4d8;
             --tw-prose-bold: #e5e5e5;
             --tw-prose-counters: #a1a1aa;
             --tw-prose-bullets: #71717a;
             --tw-prose-hr: #404040;
             --tw-prose-quotes: #e5e5e5;
             --tw-prose-quote-borders: #404040;
             --tw-prose-captions: #a1a1aa;
             --tw-prose-code: #e5e5e5;
             --tw-prose-pre-code: #d4d4d8;
             --tw-prose-pre-bg: rgba(0,0,0,0.3);
             --tw-prose-th-borders: #52525b;
             --tw-prose-td-borders: #404040;
        }
        
        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; padding-bottom: 0;}
            .stats-grid { grid-template-columns: 1fr 1fr; padding-top: 1.5rem; }
            .modal-content-unified { grid-template-columns: 1fr; max-height: 80vh; overflow-y: auto; }
        }
        @media (max-width: 480px) {
            body { height: auto; }
            .main-grid { padding: 0.5rem; }
            header { padding: 0 1rem; height: 60px; }
            .day-header .block { display: none; }
            #calendar-grid-container { grid-template-columns: 50px 1fr; }
            .time-slot { font-size: 0.65rem; }
            .stats-grid { grid-template-columns: 1fr; }
        }

        /* Pantalla completa para el editor de notas */
        .fullscreen-editor {
            position: fixed !important;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 3000;
            background: rgba(28,27,34,0.98);
            display: flex;
            flex-direction: column;
            padding: 3vw 5vw;
            box-sizing: border-box;
            border-radius: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            transition: transform 0.35s cubic-bezier(.4,0,.2,1), box-shadow 0.3s, background 0.3s, opacity 0.35s cubic-bezier(.4,0,.2,1);
            transform: scale(1.04) translateY(30px);
            opacity: 0;
        }
        .fullscreen-editor.fullscreen-active {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        .fullscreen-editor .notes-title-input {
            font-size: 2.5rem;
        }
        .fullscreen-editor .notes-editor {
            font-size: 1.2rem;
            min-height: 60vh;
            flex-grow: 1;
            background: transparent !important;
            border: 1.5px solid transparent !important;
        }
        /* Fondo transparente para el editor de notas */
        #session-notes-editor.notes-editor {
            background: transparent !important;
            border: 1.5px solid transparent !important;
        }

        .icon-btn:hover { color: var(--text-primary); }

        .sidebar-tab {
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-bottom-width: 2px;
            transition: all 0.2s ease-in-out;
            flex-grow: 1; /* Para que ocupen el mismo espacio */
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="h-20 px-6 flex items-center justify-between border-b border-gray-800 flex-shrink-0">
        <div class="flex items-center gap-3">
            <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <h1 class="text-2xl font-bold text-white">Gestor de Tiempo</h1>
        </div>
        <div>
            <button id="go-to-today-btn" class="btn btn-secondary">Hoy</button>
        </div>
    </header>

    <div id="main-content">
        <!-- Contenido Principal -->
        <main class="main-grid">
            <!-- Columna Izquierda: Tareas y Eventos -->
            <aside class="flex flex-col gap-6">
                <div class="flex items-center gap-2">
                    <input type="text" id="quick-add-task-input" class="form-input flex-grow" placeholder="Añadir tarea rápida y presionar Enter">
                    <button id="detailed-add-task-btn" class="btn btn-primary h-full" title="Añadir detallado">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>
                <div class="glassmorphism rounded-xl p-4 flex-grow flex flex-col">
                    <!-- Pestañas con Iconos -->
                    <div class="flex border-b border-gray-700">
                        <button id="all-tab-btn" class="sidebar-tab border-purple-500 text-white" title="Todos">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                        </button>
                        <button id="tasks-tab-btn" class="sidebar-tab border-transparent text-gray-400" title="Tareas">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                        </button>
                        <button id="events-tab-btn" class="sidebar-tab border-transparent text-gray-400" title="Eventos">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        </button>
                        <button id="clases-tab-btn" class="sidebar-tab border-transparent text-gray-400" title="Clases">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                        </button>
                    </div>

                    <!-- Contenedores de contenido para cada pestaña -->
                    <div class="flex-grow overflow-y-auto sidebar-scroll-container pr-2">
                        <div id="all-tab-content" class="space-y-2 mt-4"></div>
                        <div id="tasks-tab-content" class="hidden space-y-2 mt-4"></div>
                        <div id="events-tab-content" class="hidden space-y-2 mt-4"></div>
                        <div id="clases-tab-content" class="hidden space-y-2 mt-4"></div>
                    </div>
                </div>
            </aside>

            <!-- Columna Derecha: Calendario -->
            <section class="glassmorphism rounded-xl p-4 flex flex-col overflow-hidden">
                 <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <button id="prev-week-btn" class="btn btn-secondary !p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                        <button id="next-week-btn" class="btn btn-secondary !p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                    </div>
                    <span id="current-week-range" class="text-lg font-bold text-center"></span>
                    <div class="flex items-center gap-2 relative">
                         <button id="download-calendar-btn" title="Descargar Calendario" class="icon-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        <div id="download-popover" class="popover right-0 mt-8">
                            <button id="download-ics-btn" class="w-full text-left p-1 rounded hover:bg-gray-700">Descargar ICS</button>
                            <button id="download-pdf-btn" class="w-full text-left p-1 rounded hover:bg-gray-700">Descargar PDF</button>
                        </div>
                        <div class="flex items-center gap-2 bg-gray-800 p-1 rounded-lg">
                            <button id="day-view-btn" class="btn !bg-transparent !text-gray-300 px-3 py-1 text-sm">Día</button>
                            <button id="week-view-btn" class="btn !bg-transparent !text-gray-300 px-3 py-1 text-sm">Semana</button>
                        </div>
                    </div>
                </div>
                <div id="calendar-grid" class="calendar-grid relative flex-grow overflow-auto"></div>
            </section>
        </main>

        <!-- Sección de Estadísticas -->
        <footer class="stats-grid flex-shrink-0">
            <div class="stat-card glassmorphism rounded-xl col-span-2">
                <h3 class="font-bold text-lg mb-2">Estadísticas Universitarias</h3>
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <p class="text-sm text-gray-400">Próximo Examen</p>
                        <p id="stats-next-exam" class="stat-value">--</p>
                        <p class="text-xs text-gray-500">días restantes</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Tareas Pendientes</p>
                        <p id="stats-task-count" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">incl. subtareas</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Tareas Completadas</p>
                        <p id="stats-completed-tasks" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">con todas sus subtareas</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Materia con más Carga</p>
                        <p id="stats-busiest-subject" class="stat-value text-lg truncate">N/A</p>
                        <p class="text-xs text-gray-500">esta semana</p>
                    </div>
                </div>
            </div>
            <div class="stat-card glassmorphism rounded-xl col-span-2">
                <h3 class="font-bold text-lg mb-2">Resumen General</h3>
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <p class="text-sm text-gray-400">Eventos Totales</p>
                        <p id="stats-total-events" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">en la lista</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Eventos esta Semana</p>
                        <p id="stats-week-events" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">programados</p>
                    </div>
                     <div>
                        <p class="text-sm text-gray-400">Horas Programadas</p>
                        <p id="stats-week-hours" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">esta semana</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Día más Ocupado</p>
                        <p id="stats-busiest-day" class="stat-value text-lg">N/A</p>
                        <p class="text-xs text-gray-500">esta semana</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>


    <!-- Modal de Elección -->
    <div id="choice-modal" class="modal">
        <div class="modal-content-choice glassmorphism rounded-xl p-8 text-center">
            <button type="button" class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-2xl font-bold mb-6">¿Qué deseas crear?</h2>
            <div class="flex justify-around gap-4">
                <button id="create-task-btn" class="btn btn-primary w-full">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Tarea
                </button>
                <button id="create-event-btn" class="btn btn-secondary w-full">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Evento
                </button>
                <button id="create-bulk-btn" class="btn btn-secondary w-full">
                     <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg>
                    Por Lote
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Unificado -->
    <div id="unified-modal" class="modal">
        <div id="modal-content" class="modal-content-unified glassmorphism rounded-xl p-8">
            <!-- Columna de Visualización / Notas -->
            <div id="left-modal-column" class="flex flex-col">
                <!-- Contenido dinámico -->
            </div>

            <!-- Columna de Edición -->
            <div id="right-modal-column" class="border-l border-gray-700 pl-8">
                <form id="task-form" class="space-y-5 form-column">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                             <button type="button" id="delete-task-btn" title="Eliminar" class="icon-btn text-red-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                            <h2 id="modal-title" class="text-2xl font-bold">Añadir Tarea</h2>
                        </div>
                        <button type="button" class="close-modal-btn text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                    <input type="hidden" id="task-id"><input type="hidden" id="task-instance-id"><input type="hidden" id="new-event-date"><input type="hidden" id="task-item-type">
                    <div><label for="task-name" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label><input type="text" id="task-name" class="form-input" required></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="task-priority" class="block text-sm font-medium text-gray-300 mb-1">Prioridad</label><select id="task-priority" class="form-select"></select></div>
                        <div id="type-field-container"><label for="task-type" class="block text-sm font-medium text-gray-300 mb-1">Tipo</label><select id="task-type" class="form-select"></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div id="category-field-container"><label for="task-subject-category" class="block text-sm font-medium text-gray-300 mb-1">Materia / Categoría</label><select id="task-subject-category" class="form-select"></select></div>
                        <div><label for="task-color" class="block text-sm font-medium text-gray-300 mb-1">Color</label><input type="color" id="task-color" class="form-input !p-1 h-12" value="#8A5CF4"></div>
                    </div>
                    <div><label for="task-notes" class="block text-sm font-medium text-gray-300 mb-1">Notas / Descripción</label><textarea id="task-notes" class="form-input" rows="3"></textarea></div>
                    
                    <!-- Sección de Subtareas -->
                    <div id="subtask-section" class="hidden">
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Subtareas</label>
                            <button type="button" id="generate-subtasks-btn" title="Generar Subtareas con IA" class="icon-btn">
                                ✨
                            </button>
                        </div>
                        <div id="subtask-editor-list" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                        <div class="flex gap-2 mt-2">
                            <input type="text" id="new-subtask-name" class="form-input form-input-sm" placeholder="Nueva subtarea...">
                            <button type="button" id="add-subtask-btn" class="btn btn-secondary btn-sm">Añadir</button>
                        </div>
                    </div>

                    <div id="schedule-section" class="grid grid-cols-2 gap-4">
                        <div><label for="assign-start-hour" class="block text-sm font-medium text-gray-300 mb-1">Hora Inicio</label><select id="assign-start-hour" class="form-select"></select></div>
                        <div><label for="assign-end-hour" class="block text-sm font-medium text-gray-300 mb-1">Hora Fin</label><select id="assign-end-hour" class="form-select"></select></div>
                    </div>

                    <div class="flex justify-end items-center pt-4">
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Carga Masiva -->
    <div id="bulk-add-modal" class="modal">
        <div class="modal-content-unified glassmorphism rounded-xl p-8 max-w-4xl flex flex-col max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-4">Agregar por Lote</h2>
            <div class="flex gap-6 flex-grow overflow-y-auto pr-2">
                <!-- Columna Izquierda: Instrucciones y Ejemplo -->
                <div id="bulk-instructions-container" class="flex-1 space-y-4">
                    <div class="text-gray-300 text-sm space-y-2">
                        <p>Usa esta función para añadir múltiples elementos a la vez pegando un array de objetos JSON. Cada objeto representa una tarea, evento, clase o examen.</p>
                        <ul class="list-disc list-inside pl-2 space-y-1">
                            <li><b>Tareas vs. Eventos:</b> Usa <code class="code">"isEvent": false</code> para tareas (con fecha límite) y <code class="code">"isEvent": true</code> para eventos/clases (con hora de inicio y fin).</li>
                            <li><b>Fechas y Horas:</b> Las fechas deben estar en formato <code class="code">YYYY-MM-DD</code> y las horas en <code class="code">HH:MM</code>.</li>
                            <li><b>Recurrencia:</b> Para clases o eventos recurrentes, usa <code class="code">"recurringDays"</code> con un array de números (0=Domingo, 1=Lunes, ..., 6=Sábado). La <code class="code">date</code> marcará el inicio de la recurrencia.</li>
                            <li><b>Tipos:</b> Usa <code class="code">"type"</code> para categorizar (ej: "Tarea", "Clase", "Examen", "Recordatorio").</li>
                        </ul>
                    </div>
                    <div class="bg-gray-900 rounded-lg p-4 relative">
                        <button id="copy-bulk-instructions-btn" class="absolute top-2 right-2 btn btn-secondary !p-2" title="Copiar Instrucciones y Ejemplo">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                        <pre id="bulk-instructions-example" class="text-sm text-gray-300 overflow-auto"><code>[
  {
    "name": "Proyecto Final de IA",
    "isEvent": false,
    "type": "Tarea",
    "dueDate": "2024-09-15",
    "priority": 5,
    "subjectCategory": "Inteligencia Artificial"
  },
  {
    "name": "Clase de Cálculo Vectorial",
    "isEvent": true,
    "type": "Clase",
    "date": "2024-08-01",
    "start": "09:00",
    "end": "11:00",
    "recurringDays": [2, 4]
  },
  {
    "name": "Examen Parcial de Física",
    "isEvent": true,
    "type": "Examen",
    "date": "2024-08-20",
    "start": "14:00",
    "end": "16:00"
  }
]</code></pre>
                    </div>
                </div>

                <!-- Columna Derecha: Área de Pegado -->
                <div class="flex-1">
                    <textarea id="bulk-json-input" class="form-input h-full w-full" placeholder="Pega aquí tu array de JSON..."></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button class="btn btn-secondary close-modal-btn">Cancelar</button>
                <button id="process-bulk-json" class="btn btn-primary">Procesar</button>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const get = (id) => document.getElementById(id);

        // --- ESTADO DE LA APLICACIÓN ---
        let tasks = JSON.parse(localStorage.getItem('tasks-v2')) || [];
        let scheduledTasks = JSON.parse(localStorage.getItem('scheduledTasks-v2')) || {};
        let currentWeekStart = new Date();
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + (currentWeekStart.getDay() === 0 ? -6 : 1));
        currentWeekStart.setHours(0, 0, 0, 0);

        // --- FUNCIONES AUXILIARES ---
        const generateId = () => `_${Math.random().toString(36).substr(2, 9)}`;
        const saveAndRender = () => {
            localStorage.setItem('tasks-v2', JSON.stringify(tasks));
            localStorage.setItem('scheduledTasks-v2', JSON.stringify(scheduledTasks));
            renderAll();
        };
        const renderAll = () => {
            renderCalendar();
            renderTasks();
            renderCurrentTimeIndicator();
        };

        function showToast(message, type = 'success') {
            const container = get('toast-container');
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'toast';
            toast.classList.add(type === 'error' ? 'toast-error' : 'toast-success');
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('visible');
                setTimeout(() => {
                    toast.classList.remove('visible');
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }, 10);
        }

        // --- LÓGICA DE RENDERIZADO ---
        function renderCalendar() {
            const calendarGrid = get('calendar-grid');
            const weekRangeEl = get('current-week-range');
            if (!calendarGrid || !weekRangeEl) return;

            calendarGrid.innerHTML = '';

            const week = Array.from({ length: 7 }).map((_, i) => {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                return d;
            });

            const start = week[0];
            const end = week[6];
            weekRangeEl.textContent = `${start.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })} - ${end.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })}`;

            // Renderizar las líneas de tiempo y las etiquetas horarias
            for (let i = 0; i < 24; i++) {
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-slot';
                timeLabel.textContent = `${i}:00`;
                timeLabel.style.gridRow = (i * 2) + 2; 
                calendarGrid.appendChild(timeLabel);

                const gridLine = document.createElement('div');
                gridLine.className = 'grid-line';
                gridLine.style.gridRow = (i * 2) + 2;
                gridLine.style.gridColumn = '2 / span 7';
                calendarGrid.appendChild(gridLine);
            }

            week.forEach((day, dayIndex) => {
                const dayStr = day.toISOString().split('T')[0];

                // Crear encabezado del día
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.style.gridColumn = dayIndex + 2;
                dayHeader.innerHTML = `<span class="font-bold">${day.toLocaleDateString('es-ES', { weekday: 'short' })}</span> <span class="text-gray-400">${day.getDate()}</span>`;
                if (dayStr === new Date().toISOString().split('T')[0]) {
                    dayHeader.classList.add('current-day');
                }
                calendarGrid.appendChild(dayHeader);

                // Crear columna para los eventos del día
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                dayColumn.style.gridColumn = dayIndex + 2;
                dayColumn.style.gridRow = '2 / span 48'; // Ocupa todas las franjas horarias
                calendarGrid.appendChild(dayColumn);

                // Renderizar eventos para este día
                if (scheduledTasks[dayStr]) {
                    scheduledTasks[dayStr].forEach(item => {
                        const task = tasks.find(t => t.id === item.id);
                        if (!task) return;

                        const startHour = parseFloat(item.start.split(':')[0]) + parseFloat(item.start.split(':')[1]) / 60;
                        const endHour = parseFloat(item.end.split(':')[0]) + parseFloat(item.end.split(':')[1]) / 60;
                        
                        const eventEl = document.createElement('div');
                        eventEl.className = 'calendar-event';
                        eventEl.textContent = task.name;
                        eventEl.style.setProperty('--task-color', task.color || '#4A5568');
                        eventEl.style.top = `${startHour * 60}px`; // Asumiendo que la altura de la hora es 60px
                        eventEl.style.height = `${(endHour - startHour) * 60}px`;
                        eventEl.addEventListener('click', () => openUnifiedModal(task.id));
                        dayColumn.appendChild(eventEl);
                    });
                }
            });
        }

        function renderTasks() {
            const allContent = get('all-tab-content');
            const tasksContent = get('tasks-tab-content');
            const eventsContent = get('events-tab-content');
            const clasesContent = get('clases-tab-content');

            allContent.innerHTML = '';
            tasksContent.innerHTML = '';
            eventsContent.innerHTML = '';
            clasesContent.innerHTML = '';

            const nonArchived = tasks.filter(t => !t.isArchived);
            const onlyTasks = nonArchived.filter(t => !t.isEvent);
            const onlyEvents = nonArchived.filter(t => t.isEvent && t.type !== 'Clase');
            const onlyClases = nonArchived.filter(t => t.isEvent && t.type === 'Clase');

            const renderList = (container, items, emptyMsg) => {
                if (items.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-sm p-4">${emptyMsg}</p>`;
                } else {
                    items.forEach(item => container.appendChild(createTaskCard(item)));
                }
            };

            renderList(allContent, nonArchived, 'No hay elementos.');
            renderList(tasksContent, onlyTasks, 'No hay tareas pendientes.');
            renderList(eventsContent, onlyEvents, 'No hay eventos próximos.');
            renderList(clasesContent, onlyClases, 'No hay clases programadas.');
        }

        function createTaskCard(item) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.dataset.taskId = item.id;
            card.style.setProperty('--task-color', item.color || '#4A5568');
            card.draggable = true;

            const secondaryText = item.isEvent ? (item.notes || 'Sin descripción') : (item.subjectCategory || 'General');
            card.innerHTML = `
                <div class="task-header flex-grow">
                    <p class="font-semibold truncate">${item.name}</p>
                    <p class="text-sm text-gray-400 truncate">${secondaryText}</p>
                </div>`;
            
            card.addEventListener('click', () => openUnifiedModal(item.id));
            // Drag logic can be added here later if needed

            return card;
        }

        function renderCurrentTimeIndicator() {
            const calendarGrid = get('calendar-grid');
            if (!calendarGrid) return;

            let indicator = get('time-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'time-indicator';
                indicator.className = 'current-time-indicator';
                calendarGrid.appendChild(indicator);
            }
            
            const now = new Date();
            const currentHour = now.getHours() + now.getMinutes() / 60;
            
            indicator.style.top = `${currentHour * 60}px`; // Asumiendo que la altura de la hora es 60px

            // Determinar si el día de hoy está en la vista actual
            const week = Array.from({ length: 7 }).map((_, i) => {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                return d.toISOString().split('T')[0];
            });

            const todayStr = now.toISOString().split('T')[0];
            const todayIndex = week.indexOf(todayStr);

            if (todayIndex !== -1) {
                indicator.style.display = 'block';
                indicator.style.gridColumn = todayIndex + 2; // Columna 2 para el primer día (índice 0)
            } else {
                indicator.style.display = 'none'; // Ocultar si no es la semana actual
            }
        }

        // --- LÓGICA DE MODALES ---
        function openUnifiedModal(itemIdOrType) {
            const modal = get('unified-modal');
            const form = get('task-form');
            form.reset();
            get('task-id').value = '';

            const task = typeof itemIdOrType === 'string' ? tasks.find(t => t.id === itemIdOrType) : null;
            
            if (task) { // Editing existing item
                get('modal-title').textContent = `Editar ${task.type}`;
                get('task-id').value = task.id;
                get('task-name').value = task.name;
                get('notes-editor').value = task.notes || '';
                get('task-priority').value = task.priority || 0;
                get('task-subject-category').value = task.subjectCategory || '';
                get('task-type').value = task.type || 'Tarea';
                get('task-due-date').value = task.dueDate || '';
                get('task-recurring').checked = task.isRecurring || false;
            } else { // Creating new item
                get('modal-title').textContent = `Crear ${itemIdOrType}`;
                get('task-type').value = itemIdOrType;
            }

            modal.classList.add('visible');
        }

        function closeUnifiedModal() {
            get('unified-modal').classList.remove('visible');
        }

        function openBulkAddModal() {
            const modal = get('bulk-add-modal');
            modal.classList.add('visible');
            get('process-bulk-json').onclick = () => {
                const jsonInput = get('bulk-json-input').value;
                try {
                    const items = JSON.parse(jsonInput);
                    if (!Array.isArray(items)) throw new Error('El JSON debe ser un array.');
                    let itemsAdded = 0;
                    items.forEach(item => {
                        if (item.name && item.type) {
                            tasks.push({ ...item, id: generateId(), completed: false, isArchived: false });
                            itemsAdded++;
                        }
                    });
                    modal.classList.remove('visible');
                    saveAndRender();
                    showToast(`${itemsAdded} elemento(s) añadido(s) correctamente.`);
                    get('bulk-json-input').value = '';
                } catch (error) {
                    showToast(`Error en el formato JSON: ${error.message}`, 'error');
                }
            };
        }

        // --- FUNCIÓN DE INICIALIZACIÓN ---
        function init() {
            get('detailed-add-task-btn').addEventListener('click', () => get('choice-modal').classList.add('visible'));

            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal').classList.remove('visible');
                });
            });

            get('create-task-btn').addEventListener('click', () => openUnifiedModal('Tarea'));
            get('create-event-btn').addEventListener('click', () => openUnifiedModal('Evento'));
            get('create-bulk-btn').addEventListener('click', () => {
                get('choice-modal').classList.remove('visible');
                get('bulk-add-modal').classList.add('visible');
            });

            get('copy-bulk-instructions-btn').addEventListener('click', () => {
                const instructionsText = get('bulk-instructions-container').textContent;
                navigator.clipboard.writeText(instructionsText.trim()).then(() => {
                    showToast('Instrucciones copiadas al portapapeles');
                }).catch(err => {
                    console.error('Error al copiar:', err);
                    showToast('No se pudieron copiar las instrucciones', 'error');
                });
            });

            get('prev-week-btn').addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); renderAll(); });
            get('next-week-btn').addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); renderAll(); });

            get('task-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = get('task-id').value;
                const type = get('task-type').value;
                const isEvent = type !== 'Tarea';
                const taskData = {
                    name: get('task-name').value, notes: get('notes-editor').value,
                    priority: parseInt(get('task-priority').value, 10) || 0,
                    subjectCategory: get('task-subject-category').value, isEvent: isEvent, type: type,
                    dueDate: isEvent ? null : get('task-due-date').value,
                    isRecurring: isEvent ? get('task-recurring').checked : false,
                    recurringDays: isEvent ? Array.from(document.querySelectorAll('#day-picker input:checked')).map(el => parseInt(el.value)) : [],
                };
                if (id) {
                    const index = tasks.findIndex(t => t.id === id);
                    if (index !== -1) tasks[index] = { ...tasks[index], ...taskData };
                } else {
                    tasks.push({ ...taskData, id: generateId(), completed: false, subtasks: [], isArchived: false });
                }
                closeUnifiedModal();
                saveAndRender();
                showToast(`Elemento ${id ? 'actualizado' : 'creado'} correctamente.`);
            });

            const tabs = [
                { btn: get('all-tab-btn'), content: get('all-tab-content') },
                { btn: get('tasks-tab-btn'), content: get('tasks-tab-content') },
                { btn: get('events-tab-btn'), content: get('events-tab-content') },
                { btn: get('clases-tab-btn'), content: get('clases-tab-content') },
            ];
            tabs.forEach(tab => {
                if (!tab.btn) return;
                tab.btn.addEventListener('click', () => {
                    tabs.forEach(t => {
                        if (t.content) t.content.classList.add('hidden');
                        if (t.btn) {
                            t.btn.classList.remove('border-purple-500', 'text-white');
                            t.btn.classList.add('border-transparent', 'text-gray-400');
                        }
                    });
                    if (tab.content) tab.content.classList.remove('hidden');
                    if (tab.btn) {
                        tab.btn.classList.add('border-purple-500', 'text-white');
                        tab.btn.classList.remove('border-transparent', 'text-gray-400');
                    }
                });
            });

            renderAll();
            setInterval(renderCurrentTimeIndicator, 60000);
        }

        init();
    });
    </script>
</body>
</html>
