<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tiempo | Versión Final</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <!-- Estilos Personalizados -->
    <style>
        :root {
            --bg-primary: #111015;
            --bg-secondary: #1C1B22;
            --bg-tertiary: #2A2931;
            --text-primary: #F0F0F0;
            --text-secondary: #A0A0A0;
            --accent-primary: #8A5CF4;
            --accent-secondary: #6337B7;
            --border-color: #3A3942;
            --time-slot-height: 60px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            user-select: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #4F4E57; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6A6972; }

        /* --- Utilidades --- */
        .glassmorphism {
            background: rgba(28, 27, 34, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600;
            transition: all 0.2s ease; cursor: pointer; border: none;
        }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:hover { background-color: var(--accent-secondary); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: #3A3942; }
        .btn-danger { background-color: #E53E3E; color: white; }
        .btn-danger:hover { background-color: #C53030; }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }
        .icon-btn {
            background: none; border: none; color: var(--text-secondary);
            padding: 0.25rem; border-radius: 0.375rem;
            transition: color 0.2s, background-color 0.2s;
        }
        .icon-btn:hover {
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
        }

        /* --- Layout Principal --- */
        #main-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        .main-grid {
            display: grid; grid-template-columns: 350px 1fr;
            gap: 1.5rem; padding: 1.5rem; 
        }

        /* --- Tareas y Subtareas --- */
        .task-card {
            padding: 1rem; border-radius: 0.5rem; background-color: var(--bg-secondary);
            border-left: 4px solid var(--task-color, var(--accent-primary));
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .task-card:not(.selection-mode):not(.no-hover):hover { 
             transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        .task-card .task-header { cursor: pointer; }
        .task-card.dragging { opacity: 0.5; transform: scale(0.95); }

        .subtask-list {
            border-top: 1px solid var(--border-color);
            padding-top: 0.75rem;
            margin-top: 0.75rem;
        }
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            cursor: grab;
        }
        .subtask-item.completed span {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        .subtask-item.dragging {
            opacity: 0.5;
            background-color: var(--bg-tertiary);
        }
        .drag-over-area {
            background-color: rgba(138, 92, 244, 0.1);
            border: 1px dashed var(--accent-primary);
        }
        .selection-mode .task-card {
            cursor: pointer;
        }
        .selection-mode .task-card:hover {
            background-color: var(--bg-tertiary);
        }
        .task-card.selected {
            background-color: var(--accent-secondary) !important;
            border-left-color: var(--accent-primary) !important;
        }
        .task-select-checkbox {
            min-width: 1.15rem; height: 1.15rem;
            border-radius: 0.25rem; border: 2px solid var(--border-color);
            background-color: var(--bg-tertiary);
            appearance: none; -webkit-appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .task-select-checkbox:checked {
            background-color: var(--accent-primary);
            border-color: var(--accent-secondary);
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        
        /* --- Calendario con CSS Grid --- */
        #calendar-grid-container {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr); 
            grid-template-rows: auto repeat(36, calc(var(--time-slot-height) / 2));
            position: relative;
        }
        #calendar.day-view #calendar-grid-container {
             grid-template-columns: 60px 1fr;
        }
        .day-header, .time-header {
            text-align: center; font-weight: 600;
            padding: 0.75rem 0.5rem; position: sticky; top: 0;
            background-color: var(--bg-secondary); z-index: 20;
        }
        .day-header.current-day { background-color: var(--accent-primary); color: white; }
        .time-slot {
            grid-column: 1; text-align: right; font-size: 0.75rem;
            color: var(--text-secondary); padding-right: 0.5rem;
            transform: translateY(-50%);
        }
        .grid-line {
            border-top: 1px solid var(--border-color);
        }
        .day-column {
            position: relative;
            border-left: 1px solid var(--border-color);
        }
        .calendar-event {
            position: absolute; background-color: var(--task-color, var(--accent-primary));
            color: white; border-radius: 0.375rem; padding: 0.2rem 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); border: 1px solid rgba(0,0,0,0.2);
            transition: top 0.1s, height 0.1s; overflow: hidden; z-index: 10;
            cursor: pointer; display: flex; flex-direction: column;
        }
        .calendar-event.dragging, .calendar-event.resizing {
            opacity: 0.7; z-index: 20; transition: none;
        }
        .resize-handle {
            position: absolute; left: 0; right: 0; height: 8px;
            cursor: ns-resize; z-index: 15;
        }
        .resize-handle.top { top: 0; }
        .resize-handle.bottom { bottom: 0; }
        .calendar-event-preview {
            position: absolute; background-color: rgba(138, 92, 244, 0.5);
            border: 1px dashed var(--accent-primary); border-radius: 0.375rem;
            z-index: 5; pointer-events: none;
        }
        .current-time-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-primary);
            z-index: 25;
        }
        .current-time-indicator::before {
            content: '';
            position: absolute;
            left: -5px;
            top: -4px;
            width: 12px;
            height: 12px;
            background-color: var(--accent-primary);
            border-radius: 50%;
        }

        /* --- Sección de Estadísticas --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            padding: 1.5rem;
        }
        .stat-card {
            padding: 1.5rem;
        }
        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        /* --- Modal --- */
        .modal {
            position: fixed; z-index: 1000; inset: 0;
            background-color: rgba(0, 0, 0, 0.7); display: flex;
            align-items: center; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content-unified {
            width: 90%; max-width: 1050px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .modal-content-choice {
            position: relative;
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal.visible .modal-content-unified,
        .modal.visible .modal-content-choice { transform: scale(1); }
        
        .form-input, .form-select, .notes-editor {
            background-color: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 0.5rem; padding: 0.75rem; width: 100%;
            color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s;
        }
        .notes-title-input {
            background: transparent;
            border: none;
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 2.5rem;
            padding: 0;
            width: 100%;
        }
         .notes-title-input:focus {
            outline: none;
            box-shadow: none;
        }

        .form-input:focus, .form-select:focus, .notes-editor:focus {
            outline: none; border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(138, 92, 244, 0.3);
        }
        .form-column {
            max-height: 65vh;
            overflow-y: auto;
            padding-right: 1rem;
        }

        /* Popover */
        .popover {
            position: absolute;
            z-index: 100;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
        }
        
        /* Notebook view */
        #notebook-fullscreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 2000;
        }
        .prose-invert {
             --tw-prose-body: var(--text-primary);
             --tw-prose-headings: white;
             --tw-prose-lead: #a1a1aa;
             --tw-prose-links: #d4d4d8;
             --tw-prose-bold: #e5e5e5;
             --tw-prose-counters: #a1a1aa;
             --tw-prose-bullets: #71717a;
             --tw-prose-hr: #404040;
             --tw-prose-quotes: #e5e5e5;
             --tw-prose-quote-borders: #404040;
             --tw-prose-captions: #a1a1aa;
             --tw-prose-code: #e5e5e5;
             --tw-prose-pre-code: #d4d4d8;
             --tw-prose-pre-bg: rgba(0,0,0,0.3);
             --tw-prose-th-borders: #52525b;
             --tw-prose-td-borders: #404040;
        }
        
        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; padding-bottom: 0;}
            .stats-grid { grid-template-columns: 1fr 1fr; padding-top: 1.5rem; }
            .modal-content-unified { grid-template-columns: 1fr; max-height: 80vh; overflow-y: auto; }
        }
        @media (max-width: 480px) {
            body { height: auto; }
            .main-grid { padding: 0.5rem; }
            header { padding: 0 1rem; height: 60px; }
            .day-header .block { display: none; }
            #calendar-grid-container { grid-template-columns: 50px 1fr; }
            .time-slot { font-size: 0.65rem; }
            .stats-grid { grid-template-columns: 1fr; }
        }

        /* Pantalla completa para el editor de notas */
        .fullscreen-editor {
            position: fixed !important;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 3000;
            background: rgba(28,27,34,0.98);
            display: flex;
            flex-direction: column;
            padding: 3vw 5vw;
            box-sizing: border-box;
            border-radius: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            transition: transform 0.35s cubic-bezier(.4,0,.2,1), box-shadow 0.3s, background 0.3s, opacity 0.35s cubic-bezier(.4,0,.2,1);
            transform: scale(1.04) translateY(30px);
            opacity: 0;
        }
        .fullscreen-editor.fullscreen-active {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        .fullscreen-editor .notes-title-input {
            font-size: 2.5rem;
        }
        .fullscreen-editor .notes-editor {
            font-size: 1.2rem;
            min-height: 60vh;
            flex-grow: 1;
            background: transparent !important;
            border: 1.5px solid transparent !important;
        }
        /* Fondo transparente para el editor de notas */
        #session-notes-editor.notes-editor {
            background: transparent !important;
            border: 1.5px solid transparent !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="h-20 px-6 flex items-center justify-between border-b border-gray-800 flex-shrink-0">
        <div class="flex items-center gap-3">
            <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <h1 class="text-2xl font-bold text-white">Gestor de Tiempo</h1>
        </div>
        <div>
            <button id="go-to-today-btn" class="btn btn-secondary">Hoy</button>
        </div>
    </header>

    <div id="main-content">
        <!-- Contenido Principal -->
        <main class="main-grid">
            <!-- Columna Izquierda: Tareas y Eventos -->
            <aside class="flex flex-col gap-6">
                <div class="flex items-center gap-2">
                    <input type="text" id="quick-add-task-input" class="form-input flex-grow" placeholder="Añadir tarea rápida y presionar Enter">
                    <button id="detailed-add-task-btn" class="btn btn-primary h-full" title="Añadir detallado">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>
                <div class="glassmorphism rounded-xl p-4 flex-grow flex flex-col">
                    <div class="flex border-b border-gray-700 mb-4">
                        <button id="tasks-tab-btn" class="flex-1 pb-2 font-semibold border-b-2 border-purple-500 text-white">Pendientes</button>
                        <button id="notebooks-tab-btn" class="flex-1 pb-2 font-semibold border-b-2 border-transparent text-gray-400">Cuadernos</button>
                        <button id="bulk-add-tab-btn" class="flex-1 pb-2 font-semibold border-b-2 border-transparent text-gray-400">Por Lote</button>
                    </div>
                    
                    <div id="tasks-tab-content" class="flex flex-col flex-grow min-h-0">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Tareas</h2>
                            <div class="flex items-center gap-2 relative">
                                <div id="task-actions" class="flex items-center gap-2">
                                    <button id="sort-tasks-btn" title="Ordenar Tareas" class="icon-btn">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9M3 12h9m-9 4h13m-5-4v8m0 0l-4-4m4 4l4-4"></path></svg>
                                    </button>
                                    <div id="sort-tasks-popover" class="popover right-0 mt-8">
                                        <button data-sort="priority" class="w-full text-left p-1 rounded hover:bg-gray-700">Prioridad</button>
                                        <button data-sort="name" class="w-full text-left p-1 rounded hover:bg-gray-700">Nombre (A-Z)</button>
                                    </div>
                                    <button id="select-tasks-btn" title="Seleccionar Tareas" class="icon-btn">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                    </button>
                                </div>
                                <div id="select-mode-actions-tasks" class="hidden items-center gap-2">
                                    <button id="select-all-tasks-btn" title="Seleccionar Todas las Tareas" class="icon-btn">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/><path d="M16 3h5v5"/></svg>
                                    </button>
                                    <button id="delete-selected-tasks-btn" title="Eliminar Tareas Seleccionadas" class="icon-btn text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                    <button id="cancel-select-tasks-btn" title="Cancelar Selección" class="icon-btn">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="task-list-tareas" class="space-y-3 overflow-y-auto pr-2 flex-grow min-h-0"></div>

                        <div class="flex justify-between items-center my-4 pt-4 border-t border-gray-700">
                            <h2 class="text-xl font-semibold">Eventos</h2>
                            <div class="flex items-center gap-2 relative">
                                <div id="event-actions" class="flex items-center gap-2">
                                    <button id="sort-events-btn" title="Ordenar Eventos" class="icon-btn">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9M3 12h9m-9 4h13m-5-4v8m0 0l-4-4m4 4l4-4"></path></svg>
                                    </button>
                                    <div id="sort-events-popover" class="popover right-0 mt-8">
                                        <button data-sort="proximity" class="w-full text-left p-1 rounded hover:bg-gray-700">Proximidad</button>
                                        <button data-sort="name" class="w-full text-left p-1 rounded hover:bg-gray-700">Nombre (A-Z)</button>
                                    </div>
                                    <button id="select-events-btn" title="Seleccionar Eventos" class="icon-btn">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                    </button>
                                </div>
                                <div id="select-mode-actions-events" class="hidden items-center gap-2">
                                    <button id="select-all-events-btn" title="Seleccionar Todos los Eventos" class="icon-btn">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/><path d="M16 3h5v5"/></svg>
                                    </button>
                                    <button id="delete-selected-events-btn" title="Eliminar Eventos Seleccionados" class="icon-btn text-red-500">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                    <button id="cancel-select-events-btn" title="Cancelar Selección" class="icon-btn">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="task-list-eventos" class="space-y-3 overflow-y-auto pr-2 flex-grow min-h-0"></div>
                    </div>

                    <div id="notebooks-tab-content" class="hidden flex-col flex-grow min-h-0">
                        <h2 class="text-xl font-semibold mb-4">Cuadernos de Materias</h2>
                        <div id="notebook-list" class="space-y-3 overflow-y-auto pr-2"></div>
                    </div>

                    <div id="bulk-add-tab-content" class="hidden space-y-4 overflow-y-auto">
                        <h2 class="text-xl font-semibold">Añadir por Lote (JSON)</h2>
                        <div>
                            <p class="text-sm text-gray-400 mb-2">Pega un array de objetos JSON. Cada objeto representa una tarea/evento.</p>
                            <h3 class="font-semibold mt-4 mb-1">Estructura del Objeto:</h3>
                            <ul class="text-xs text-gray-500 list-disc list-inside space-y-1">
                                <li><code>name</code>: (string, requerido)</li>
                                <li><code>itemType</code>: (string, opcional) "task" o "event". Si se omite, se infiere de `type`.</li>
                                <li><code>type</code>: (string, opcional) "Clase" se trata como evento.</li>
                                <li><code>subjectCategory</code>: (string, opcional)</li>
                                <li><code>color</code>: (string, opcional) Hexadecimal (ej. "#8A5CF4").</li>
                                <li><code>notes</code>: (string, opcional)</li>
                                <li><code>subtasks</code>: (array, opcional) Solo para `itemType: 'task'`. Lista de `{name, completed}`.</li>
                                <li><code>events</code>: (array, opcional) Lista de eventos a programar.</li>
                            </ul>
                             <h3 class="font-semibold mt-4 mb-1">Estructura del Evento (en `events`):</h3>
                             <ul class="text-xs text-gray-500 list-disc list-inside space-y-1">
                                <li><code>date</code>: (string, requerido) "YYYY-MM-DD".</li>
                                <li><code>startHour</code>, <code>endHour</code>: (string, requerido) "HH:MM".</li>
                                <li><code>isRecurrent</code>, <code>repeatOn</code>, <code>repeatUntil</code>: (opcional) Para eventos recurrentes.</li>
                            </ul>
                        </div>
                        <textarea id="bulk-json-input" class="form-input w-full h-40 text-xs" placeholder="[ ... ]"></textarea>
                        <button id="add-bulk-btn" class="btn btn-primary w-full">Añadir por Lote</button>
                    </div>
                </div>
            </aside>

            <!-- Columna Derecha: Calendario -->
            <section class="glassmorphism rounded-xl p-4 flex flex-col overflow-hidden">
                 <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <button id="prev-week-btn" class="btn btn-secondary !p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path></svg></button>
                        <button id="next-week-btn" class="btn btn-secondary !p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path></svg></button>
                    </div>
                    <span id="current-week-range" class="text-lg font-bold text-center"></span>
                    <div class="flex items-center gap-2 relative">
                         <button id="download-calendar-btn" title="Descargar Calendario" class="icon-btn">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </button>
                        <div id="download-popover" class="popover right-0 mt-8">
                            <button id="download-ics-btn" class="w-full text-left p-1 rounded hover:bg-gray-700">Descargar ICS</button>
                            <button id="download-pdf-btn" class="w-full text-left p-1 rounded hover:bg-gray-700">Descargar PDF</button>
                        </div>
                        <div class="flex items-center gap-2 bg-gray-800 p-1 rounded-lg">
                            <button id="day-view-btn" class="btn !bg-transparent !text-gray-300 px-3 py-1 text-sm">Día</button>
                            <button id="week-view-btn" class="btn !bg-transparent !text-gray-300 px-3 py-1 text-sm">Semana</button>
                        </div>
                    </div>
                </div>
                <div id="calendar" class="relative flex-grow overflow-auto"></div>
            </section>
        </main>

        <!-- Sección de Estadísticas -->
        <footer class="stats-grid flex-shrink-0">
            <div class="stat-card glassmorphism rounded-xl col-span-2">
                <h3 class="font-bold text-lg mb-2">Estadísticas Universitarias</h3>
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <p class="text-sm text-gray-400">Próximo Examen</p>
                        <p id="stats-next-exam" class="stat-value">--</p>
                        <p class="text-xs text-gray-500">días restantes</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Tareas Pendientes</p>
                        <p id="stats-task-count" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">incl. subtareas</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Tareas Completadas</p>
                        <p id="stats-completed-tasks" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">con todas sus subtareas</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Materia con más Carga</p>
                        <p id="stats-busiest-subject" class="stat-value text-lg truncate">N/A</p>
                        <p class="text-xs text-gray-500">esta semana</p>
                    </div>
                </div>
            </div>
            <div class="stat-card glassmorphism rounded-xl col-span-2">
                <h3 class="font-bold text-lg mb-2">Resumen General</h3>
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <p class="text-sm text-gray-400">Eventos Totales</p>
                        <p id="stats-total-events" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">en la lista</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Eventos esta Semana</p>
                        <p id="stats-week-events" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">programados</p>
                    </div>
                     <div>
                        <p class="text-sm text-gray-400">Horas Programadas</p>
                        <p id="stats-week-hours" class="stat-value">0</p>
                        <p class="text-xs text-gray-500">esta semana</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400">Día más Ocupado</p>
                        <p id="stats-busiest-day" class="stat-value text-lg">N/A</p>
                        <p class="text-xs text-gray-500">esta semana</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>


    <!-- Modal de Elección -->
    <div id="choice-modal" class="modal">
        <div class="modal-content-choice glassmorphism rounded-xl p-8 text-center">
            <button type="button" class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-2xl font-bold mb-6">¿Qué deseas crear?</h2>
            <div class="flex justify-around gap-4">
                <button id="create-task-btn" class="btn btn-primary w-full">Tarea</button>
                <button id="create-event-btn" class="btn btn-secondary w-full">Evento</button>
            </div>
        </div>
    </div>

    <!-- Modal Unificado -->
    <div id="unified-modal" class="modal">
        <div id="modal-content" class="modal-content-unified glassmorphism rounded-xl p-8">
            <!-- Columna de Visualización / Notas -->
            <div id="left-modal-column" class="flex flex-col">
                <!-- Contenido dinámico -->
            </div>

            <!-- Columna de Edición -->
            <div id="right-modal-column" class="border-l border-gray-700 pl-8">
                <form id="task-form" class="space-y-5 form-column">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                             <button type="button" id="delete-task-btn" title="Eliminar" class="icon-btn text-red-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                            <h2 id="modal-title" class="text-2xl font-bold">Añadir Tarea</h2>
                        </div>
                        <button type="button" class="close-modal-btn text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                    <input type="hidden" id="task-id"><input type="hidden" id="task-instance-id"><input type="hidden" id="new-event-date"><input type="hidden" id="task-item-type">
                    <div><label for="task-name" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label><input type="text" id="task-name" class="form-input" required></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="task-priority" class="block text-sm font-medium text-gray-300 mb-1">Prioridad</label><select id="task-priority" class="form-select"></select></div>
                        <div id="type-field-container"><label for="task-type" class="block text-sm font-medium text-gray-300 mb-1">Tipo</label><select id="task-type" class="form-select"></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div id="category-field-container"><label for="task-subject-category" class="block text-sm font-medium text-gray-300 mb-1">Materia / Categoría</label><select id="task-subject-category" class="form-select"></select></div>
                        <div><label for="task-color" class="block text-sm font-medium text-gray-300 mb-1">Color</label><input type="color" id="task-color" class="form-input !p-1 h-12" value="#8A5CF4"></div>
                    </div>
                    <div><label for="task-notes" class="block text-sm font-medium text-gray-300 mb-1">Notas / Descripción</label><textarea id="task-notes" class="form-input" rows="3"></textarea></div>
                    
                    <!-- Sección de Subtareas -->
                    <div id="subtask-section" class="hidden">
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Subtareas</label>
                            <button type="button" id="generate-subtasks-btn" title="Generar Subtareas con IA" class="icon-btn">
                                ✨
                            </button>
                        </div>
                        <div id="subtask-editor-list" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                        <div class="flex gap-2 mt-2">
                            <input type="text" id="new-subtask-name" class="form-input form-input-sm" placeholder="Nueva subtarea...">
                            <button type="button" id="add-subtask-btn" class="btn btn-secondary btn-sm">Añadir</button>
                        </div>
                    </div>

                    <div id="schedule-section" class="grid grid-cols-2 gap-4">
                        <div><label for="assign-start-hour" class="block text-sm font-medium text-gray-300 mb-1">Hora Inicio</label><select id="assign-start-hour" class="form-select"></select></div>
                        <div><label for="assign-end-hour" class="block text-sm font-medium text-gray-300 mb-1">Hora Fin</label><select id="assign-end-hour" class="form-select"></select></div>
                    </div>

                    <div class="flex justify-end items-center pt-4">
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURACIÓN Y ESTADO ---
        const STORAGE_KEYS = { tasks: 'timeManager_tasks_v5', schedule: 'timeManager_schedule_v5' };
        const getFromStorage = (key, def) => { 
            try { 
                const data = JSON.parse(localStorage.getItem(key)) || def;
                if (key === STORAGE_KEYS.tasks && Array.isArray(data)) {
                    // Patch para datos antiguos sin itemType o subtasks
                    data.forEach(task => {
                        if (!task.itemType) {
                            task.itemType = (task.type === 'Clase') ? 'event' : 'task';
                        }
                        if (task.itemType === 'task' && !Array.isArray(task.subtasks)) {
                            task.subtasks = [];
                        }
                    });
                }
                return data;
            } catch { 
                return def; 
            } 
        };
        const saveToStorage = (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch (e) { console.error(e); } };
        
        let tasks = getFromStorage(STORAGE_KEYS.tasks, []);
        let scheduledTasks = getFromStorage(STORAGE_KEYS.schedule, {});
        let currentWeekStart = getStartOfWeek(new Date());
        let currentView = 'week';
        let draggedItemInfo = null;
        let isSelectModeActive = false;
        let selectedTaskIds = new Set();
        let taskSortOrder = 'default';
        let eventSortOrder = 'default';

        // --- REFERENCIAS AL DOM ---
        const dom = new Proxy({}, { get: (_, prop) => document.getElementById(prop) });
        
        // --- FUNCIONES AUXILIARES ---
        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        function getStartOfWeek(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setHours(0, 0, 0, 0);
            return new Date(date.setDate(diff));
        }
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            dom['toast-container'].appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        const varToNumber = (name) => parseFloat(getComputedStyle(document.documentElement).getPropertyValue(name));
        const debounce = (func, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; };


        // --- LÓGICA DE DRAG AND DROP ---
        function handleDragStart(e, item, parentTask = null) {
            e.stopPropagation();
            draggedItemInfo = {
                itemId: item.id,
                isSubtask: !!parentTask,
                parentId: parentTask ? parentTask.id : null,
                type: item.itemType
            };
            e.dataTransfer.setData('text/plain', item.id);
            setTimeout(() => e.target.closest('.task-card').classList.add('dragging'), 0);
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function handleListDrop(e, itemType) {
            e.preventDefault();
            e.stopPropagation();

            if (!draggedItemInfo || draggedItemInfo.isSubtask || draggedItemInfo.type !== itemType) {
                return;
            }

            const container = e.currentTarget;
            const draggedItemId = draggedItemInfo.itemId;
            
            const draggedItemIndex = tasks.findIndex(t => t.id === draggedItemId);
            if (draggedItemIndex === -1) return;

            const [draggedItem] = tasks.splice(draggedItemIndex, 1);
            
            const afterElement = getDragAfterElement(container, e.clientY);

            if (afterElement === undefined) { // Dropped at the end
                tasks.push(draggedItem);
            } else {
                const afterElementId = afterElement.dataset.taskId;
                const dropIndex = tasks.findIndex(t => t.id === afterElementId);
                tasks.splice(dropIndex, 0, draggedItem);
            }
            
            saveAndRender();
        }

        function handleSubtaskDrop(e, targetParentTask) {
            e.preventDefault();
            e.stopPropagation();
            document.querySelectorAll('.drag-over-area').forEach(el => el.classList.remove('drag-over-area'));
            
            if (!draggedItemInfo || !targetParentTask || !draggedItemInfo.isSubtask) return;
            if (draggedItemInfo.parentId === targetParentTask.id) return;

            const sourceParent = tasks.find(t => t.id === draggedItemInfo.parentId);
            if (!sourceParent) return;

            const subtaskIndex = sourceParent.subtasks.findIndex(st => st.id === draggedItemInfo.itemId);
            if (subtaskIndex === -1) return;

            const [subtaskToMove] = sourceParent.subtasks.splice(subtaskIndex, 1);
            if (!targetParentTask.subtasks) {
                targetParentTask.subtasks = [];
            }
            targetParentTask.subtasks.push(subtaskToMove);

            saveAndRender();
        }

        function handleDragEnd(e) {
            if (e.target) {
               const card = e.target.closest('.task-card');
               if(card) card.classList.remove('dragging');
            }
            document.querySelectorAll('.drag-over-area').forEach(el => el.classList.remove('drag-over-area'));
            draggedItemInfo = null;
        }


        // --- RENDERIZADO ---
        function createTaskCard(item) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.dataset.taskId = item.id;
            card.style.setProperty('--task-color', item.color);

            const taskHeader = document.createElement('div');
            taskHeader.className = 'task-header flex-grow';
            
            const secondaryText = item.itemType === 'event' ? (item.notes || 'Sin descripción') : (item.subjectCategory || 'General');
            taskHeader.innerHTML = `
                <p class="font-semibold truncate">${item.name}</p>
                <p class="text-sm text-gray-400 truncate">${secondaryText}</p>`;
            
            if (isSelectModeActive) {
                const isChecked = selectedTaskIds.has(item.id);
                card.classList.toggle('selected', isChecked);
                const container = document.createElement('div');
                container.className = 'flex items-center gap-3';
                container.innerHTML = `<input type="checkbox" data-task-id="${item.id}" class="task-select-checkbox" ${isChecked ? 'checked' : ''}>`;
                container.appendChild(taskHeader);
                card.appendChild(container);

                card.addEventListener('click', (e) => {
                    const checkbox = card.querySelector('.task-select-checkbox');
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                    const event = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(event);
                });

                const checkbox = card.querySelector('.task-select-checkbox');
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.taskId;
                    if (e.target.checked) {
                        selectedTaskIds.add(id);
                    } else {
                        selectedTaskIds.delete(id);
                    }
                    card.classList.toggle('selected', e.target.checked);
                });

            } else {
                card.appendChild(taskHeader);
                card.draggable = true;
                card.addEventListener('dragstart', (e) => handleDragStart(e, item));
                card.addEventListener('dragend', handleDragEnd);
            }

            if (item.itemType === 'task') {
                card.classList.add('no-hover');
                if(!isSelectModeActive) taskHeader.addEventListener('click', () => openUnifiedModal(item.id));
                
                const subtaskList = document.createElement('div');
                subtaskList.className = 'subtask-list';
                if (!item.subtasks || item.subtasks.length === 0) {
                    subtaskList.style.display = 'none';
                }

                if (!item.subtasks) item.subtasks = [];

                item.subtasks.forEach(subtask => {
                    const subtaskEl = document.createElement('div');
                    subtaskEl.className = 'subtask-item';
                    subtaskEl.dataset.subtaskId = subtask.id;
                    if(!isSelectModeActive) subtaskEl.draggable = true;
                    if (subtask.completed) subtaskEl.classList.add('completed');
                    
                    subtaskEl.innerHTML = `
                        <input type="checkbox" class="task-select-checkbox" ${subtask.completed ? 'checked' : ''}>
                        <span class="flex-grow">${subtask.name}</span>`;
                    
                    if(!isSelectModeActive) {
                        subtaskEl.addEventListener('dragstart', (e) => handleDragStart(e, subtask, item));
                        subtaskEl.addEventListener('dragend', handleDragEnd);
                    }
                    
                    subtaskEl.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                        subtask.completed = e.target.checked;
                        saveAndRender();
                    });

                    subtaskList.appendChild(subtaskEl);
                });
                card.appendChild(subtaskList);

                if(!isSelectModeActive) {
                    card.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        const dropZone = e.target.closest('.task-card[data-task-id]');
                        document.querySelectorAll('.drag-over-area').forEach(el => el.classList.remove('drag-over-area'));

                        if (draggedItemInfo && draggedItemInfo.isSubtask && dropZone) {
                            if (draggedItemInfo.parentId !== dropZone.dataset.taskId) {
                                dropZone.classList.add('drag-over-area');
                            }
                        }
                    });
                    card.addEventListener('drop', (e) => handleSubtaskDrop(e, item));
                    card.addEventListener('dragleave', () => card.classList.remove('drag-over-area'));

                    const addSubtaskInput = document.createElement('input');
                    addSubtaskInput.type = 'text';
                    addSubtaskInput.placeholder = '+ Añadir subtarea';
                    addSubtaskInput.className = 'form-input w-full mt-2 text-sm !py-1';
                    addSubtaskInput.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter' && e.target.value.trim()) {
                            const newSubtask = {
                                id: generateId(),
                                name: e.target.value.trim(),
                                completed: false
                            };
                            item.subtasks.push(newSubtask);
                            e.target.value = '';
                            saveAndRender();
                        }
                    });
                    card.appendChild(addSubtaskInput);
                }
            } else {
                if(!isSelectModeActive) taskHeader.addEventListener('click', () => openUnifiedModal(item.id));
            }

            return card;
        }

        function renderTasks() {
            const taskListTareas = dom['task-list-tareas'];
            const taskListEventos = dom['task-list-eventos'];
            taskListTareas.innerHTML = '';
            taskListEventos.innerHTML = '';
            taskListTareas.closest('#tasks-tab-content').classList.toggle('selection-mode', isSelectModeActive);

            let items_tareas = tasks.filter(t => t.itemType === 'task');
            let items_eventos = tasks.filter(t => t.itemType === 'event');

            // Ordenar Tareas
            const priorityMap = { 'Alta': 0, 'Media': 1, 'Baja': 2 };
            if (taskSortOrder === 'priority') {
                items_tareas.sort((a, b) => (priorityMap[a.priority] || 2) - (priorityMap[b.priority] || 2));
            } else if (taskSortOrder === 'name') {
                items_tareas.sort((a, b) => a.name.localeCompare(b.name));
            }

            // Ordenar Eventos
            if (eventSortOrder === 'name') {
                items_eventos.sort((a, b) => a.name.localeCompare(b.name));
            } else if (eventSortOrder === 'proximity') {
                const today = new Date().toISOString().slice(0, 10);
                const getNextDate = (eventId) => {
                    const futureEvents = Object.values(scheduledTasks)
                        .filter(e => e.taskId === eventId && e.date >= today)
                        .sort((a, b) => a.date.localeCompare(b.date));
                    return futureEvents.length > 0 ? futureEvents[0].date : '9999-12-31';
                };
                items_eventos.sort((a, b) => getNextDate(a.id).localeCompare(getNextDate(b.id)));
            }


            if (items_tareas.length === 0) {
                taskListTareas.innerHTML = `<p class="text-center text-gray-500 text-sm py-4">No hay tareas.</p>`;
            } else {
                items_tareas.forEach(item => taskListTareas.appendChild(createTaskCard(item)));
            }

            if (items_eventos.length === 0) {
                taskListEventos.innerHTML = `<p class="text-center text-gray-500 text-sm py-4">No hay eventos.</p>`;
            } else {
                items_eventos.forEach(item => taskListEventos.appendChild(createTaskCard(item)));
            }
        }

        function renderScheduledTasks(daysToShow) {
            const container = dom.calendar.querySelector('#calendar-grid-container');
            if (!container) return;
            container.querySelectorAll('.calendar-event').forEach(e => e.remove());

            daysToShow.forEach((date) => {
                const dateStr = date.toISOString().slice(0, 10);
                const column = container.querySelector(`.day-column[data-date="${dateStr}"]`);
                if (!column) return;
                
                let dailyEvents = Object.entries(scheduledTasks)
                    .filter(([, event]) => event.date === dateStr)
                    .map(([instanceId, event]) => {
                        const task = tasks.find(t => t.id === event.taskId) || { name: 'Tarea eliminada', color: '#E53E3E' };
                        const [startH, startM] = event.startHour.split(':').map(Number);
                        const [endH, endM] = event.endHour.split(':').map(Number);
                        return { ...event, instanceId, name: task.name, color: task.color, start: startH + startM / 60, end: endH + endM / 60 };
                    })
                    .sort((a, b) => a.start - b.start);

                const eventLevels = [];
                dailyEvents.forEach(event => {
                    let placed = false;
                    for (let i = 0; i < eventLevels.length; i++) {
                        if (!eventLevels[i].some(e2 => event.start < e2.end && event.end > e2.start)) {
                            eventLevels[i].push(event); event.level = i; placed = true; break;
                        }
                    }
                    if (!placed) { event.level = eventLevels.length; eventLevels.push([event]); }
                });
                const totalLevels = Math.max(1, eventLevels.length);

                dailyEvents.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'calendar-event';
                    eventDiv.dataset.instanceId = event.instanceId;
                    eventDiv.style.setProperty('--task-color', event.color);
                    
                    const top = (event.start - 6) * varToNumber('--time-slot-height');
                    const height = (event.end - event.start) * varToNumber('--time-slot-height');
                    const eventGroupWidth = 100 / totalLevels;
                    const left = event.level * eventGroupWidth;

                    eventDiv.style.top = `${top}px`;
                    eventDiv.style.height = `${height}px`;
                    eventDiv.style.left = `${left}%`;
                    eventDiv.style.width = `${eventGroupWidth}%`;

                    eventDiv.innerHTML = `<div class="font-semibold text-xs truncate">${event.name}</div><div class="text-xs">${event.startHour} - ${event.endHour}</div><div class="resize-handle top"></div><div class="resize-handle bottom"></div>`;
                    column.appendChild(eventDiv);
                });
            });
        }

        function renderCurrentTimeIndicator() {
            const existingIndicator = dom.calendar.querySelector('.current-time-indicator');
            if (existingIndicator) existingIndicator.remove();

            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            const column = dom.calendar.querySelector(`.day-column[data-date="${todayStr}"]`);

            if (column) { 
                const hourHeight = varToNumber('--time-slot-height');
                const minutesSince6AM = (now.getHours() * 60 + now.getMinutes()) - (6 * 60);
                
                if (minutesSince6AM >= 0 && minutesSince6AM <= 18 * 60) {
                    const topPosition = (minutesSince6AM / 60) * hourHeight;
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'current-time-indicator';
                    indicator.style.top = `${topPosition}px`;
                    
                    column.appendChild(indicator);
                }
            }
        }

        function renderCalendar() {
            const isMobile = window.innerWidth < 768;
            const WEEKDAYS = isMobile ? ["L", "M", "X", "J", "V", "S", "D"] : ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
            const weekDates = Array.from({ length: 7 }, (_, i) => new Date(new Date(currentWeekStart).setDate(currentWeekStart.getDate() + i)));
            const daysToShow = currentView === 'day' ? [new Date()] : weekDates;
            
            dom['current-week-range'].textContent = `${weekDates[0].toLocaleDateString('es-ES', {day:'numeric', month:'long'})} - ${weekDates[6].toLocaleDateString('es-ES', {day:'numeric', month:'long', year:'numeric'})}`;
            
            let gridHtml = `<div id="calendar-grid-container">`;
            gridHtml += '<div class="time-header"></div>';
            daysToShow.forEach(date => {
                const isToday = date.toDateString() === new Date().toDateString();
                gridHtml += `<div class="day-header ${isToday ? 'current-day' : ''}">${WEEKDAYS[date.getDay() === 0 ? 6 : date.getDay() - 1]} <span class="block text-xs font-normal">${date.getDate()}</span></div>`;
            });
            for (let i = 0; i < 36; i++) {
                const hour = 6 + Math.floor(i / 2);
                if (i % 2 === 0) {
                    gridHtml += `<div class="time-slot" style="grid-row: ${i + 2}">${hour}:00</div>`;
                }
                const row = i + 2;
                gridHtml += `<div class="grid-line" style="grid-row: ${row}; grid-column: 2 / span ${daysToShow.length};"></div>`;
            }
            daysToShow.forEach((date, index) => {
                gridHtml += `<div class="day-column" data-date="${date.toISOString().slice(0, 10)}" style="grid-column: ${index + 2}; grid-row: 2 / span 36;"></div>`;
            });
            gridHtml += '</div>';
            dom.calendar.innerHTML = gridHtml;
            if (currentView === 'day') {
                dom.calendar.classList.add('day-view');
            } else {
                dom.calendar.classList.remove('day-view');
            }
            
            setTimeout(() => {
                renderScheduledTasks(daysToShow);
                setupCalendarInteractions();
                renderCurrentTimeIndicator();
            }, 0);
        }
        
        // --- INTERACCIONES Y MODALES ---
        function setupCalendarInteractions() {
            const container = dom.calendar.querySelector('#calendar-grid-container');
            if (!container) return;
            
            container.querySelectorAll('.day-column').forEach(column => {
                column.addEventListener('dragover', e => { 
                    e.preventDefault(); 
                    const draggedCard = document.querySelector('.task-card.dragging');
                    if (draggedCard) {
                        e.currentTarget.style.backgroundColor = 'rgba(138, 92, 244, 0.2)';
                    }
                });
                column.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = ''; });
                column.addEventListener('drop', e => {
                    e.preventDefault();
                    e.currentTarget.style.backgroundColor = '';
                    const taskId = e.dataTransfer.getData('text/plain');
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return;

                    const rect = e.currentTarget.getBoundingClientRect();
                    const hourHeight = varToNumber('--time-slot-height');
                    const hour = 6 + (e.clientY - rect.top) / hourHeight;
                    const startHour = Math.floor(hour) + (Math.round((hour % 1) * 2) / 2);
                    const format = h => `${String(Math.floor(h)).padStart(2,'0')}:${String((h%1)*60).padStart(2,'0')}`;

                    const newInstance = { taskId: task.id, date: column.dataset.date, startHour: format(startHour), endHour: format(startHour + 1) };
                    scheduledTasks[generateId()] = newInstance;
                    saveAndRender();
                    showToast('Evento programado');
                });
            });

            let draggedEl, resizeMode, isCreating, createPreviewEl;
            let initialY, initialTop, initialHeight, initialMouseX;
            let startColumn;

            const onMouseMove = (e) => {
                const hourHeight = varToNumber('--time-slot-height');
                const gridStep = hourHeight / 2;
                if (isCreating) {
                    if (!createPreviewEl) return;
                    const dy = e.clientY - initialY;
                    const newHeight = Math.max(gridStep, Math.round((initialHeight + dy) / gridStep) * gridStep);
                    createPreviewEl.style.height = `${newHeight}px`;
                } else if (draggedEl) {
                    const dy = e.clientY - initialY;
                    if (resizeMode === 'start') {
                        const newTop = Math.round((initialTop + dy) / gridStep) * gridStep;
                        draggedEl.style.top = `${newTop}px`;
                        draggedEl.style.height = `${initialHeight - (newTop - initialTop)}px`;
                    } else if (resizeMode === 'end') {
                        draggedEl.style.height = `${Math.max(gridStep, Math.round((initialHeight + dy) / gridStep) * gridStep)}px`;
                    } else { // Mover
                        const dx = e.clientX - initialMouseX;
                        draggedEl.style.transform = `translate(${dx}px, ${dy}px)`;
                    }
                }
            };

            const onMouseUp = (e) => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);

                if (isCreating) {
                    if (createPreviewEl) {
                        const hourHeight = varToNumber('--time-slot-height');
                        const startHour = 6 + (createPreviewEl.offsetTop / hourHeight);
                        const endHour = startHour + (createPreviewEl.offsetHeight / hourHeight);
                        const format = h => `${String(Math.floor(h)).padStart(2,'0')}:${String(Math.round((h%1)*60)).padStart(2,'0')}`;
                        createPreviewEl.remove();
                        openUnifiedModal(null, null, { date: startColumn.dataset.date, startHour: format(startHour), endHour: format(endHour), itemType: 'event' });
                    }
                } else if (draggedEl) {
                    const instanceId = draggedEl.dataset.instanceId;
                    const eventData = scheduledTasks[instanceId];
                    const dx = e.clientX - initialMouseX;
                    const dy = e.clientY - initialY;
                    const distance = Math.sqrt(dx*dx + dy*dy);

                    if (distance < 5 && !resizeMode) { // Es un clic
                        openUnifiedModal(eventData.taskId, instanceId);
                    } else if (eventData) { // Es un drag o resize
                        draggedEl.style.transform = 'translate(0,0)';
                        const hourHeight = varToNumber('--time-slot-height');
                        const gridStep = hourHeight / 2;
                        const format = h => `${String(Math.floor(h)).padStart(2,'0')}:${String(Math.round((h%1)*60)).padStart(2,'0')}`;

                        if (resizeMode) {
                            const finalTop = draggedEl.offsetTop;
                            const finalHeight = draggedEl.offsetHeight;
                            eventData.startHour = format(6 + (finalTop / hourHeight));
                            eventData.endHour = format(6 + (finalTop + finalHeight) / hourHeight);
                        } else {
                            const columns = Array.from(container.querySelectorAll('.day-column'));
                            const rects = columns.map(c => c.getBoundingClientRect());
                            const mouseX = e.clientX;
                            
                            let dayIndex = rects.findIndex(rect => mouseX >= rect.left && mouseX < rect.right);
                            if (dayIndex === -1) dayIndex = 0;

                            const column = columns[dayIndex];
                            
                            const finalTop = initialTop + dy;
                            const snappedTop = Math.round(finalTop / gridStep) * gridStep;
                            
                            const newStartHour = 6 + (snappedTop / hourHeight);
                            const eventDuration = (new Date(`1970-01-01T${eventData.endHour}`) - new Date(`1970-01-01T${eventData.startHour}`)) / 3600000;
                            const newEndHour = newStartHour + eventDuration;
                            
                            eventData.startHour = format(newStartHour);
                            eventData.endHour = format(newEndHour);
                            eventData.date = column.dataset.date;
                        }
                        
                        saveAndRender();
                    }
                    draggedEl.classList.remove('dragging', 'resizing');
                }
                draggedEl = null;
                isCreating = false;
                resizeMode = null;
                renderCalendar();
            };
            
            container.querySelectorAll('.day-column').forEach(column => {
                column.addEventListener('mousedown', e => {
                    if (e.button !== 0 || e.target.closest('.calendar-event')) return;

                    isCreating = true;
                    startColumn = column;
                    const rect = column.getBoundingClientRect();
                    
                    const hourHeight = varToNumber('--time-slot-height');
                    const gridStep = hourHeight / 2;
                    const relativeMouseY = e.clientY - rect.top;
                    
                    initialTop = Math.floor(relativeMouseY / gridStep) * gridStep;
                    
                    createPreviewEl = document.createElement('div');
                    createPreviewEl.className = 'calendar-event-preview';
                    createPreviewEl.style.top = `${initialTop}px`;
                    createPreviewEl.style.left = `0px`;
                    createPreviewEl.style.width = `100%`;
                    createPreviewEl.style.height = `${gridStep}px`;
                    
                    column.appendChild(createPreviewEl);
                    initialY = e.clientY;
                    initialHeight = gridStep;
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });

            container.querySelectorAll('.calendar-event').forEach(el => {
                el.addEventListener('mousedown', e => {
                    if (e.button !== 0) return;
                    e.stopPropagation();
                    isCreating = false;
                    draggedEl = el;
                    initialY = e.clientY;
                    initialMouseX = e.clientX;
                    initialTop = draggedEl.offsetTop;
                    if (e.target.classList.contains('resize-handle')) {
                        resizeMode = e.target.classList.contains('top') ? 'start' : 'end';
                        initialHeight = draggedEl.offsetHeight;
                        draggedEl.classList.add('resizing');
                    } else {
                        resizeMode = null;
                        draggedEl.classList.add('dragging');
                    }
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });
        }

        function openUnifiedModal(taskId = null, instanceId = null, defaults = {}) {
            dom['task-form'].reset();
            const isEditing = !!taskId;
            const task = isEditing ? tasks.find(t => t.id === taskId) : {};
            const event = instanceId ? scheduledTasks[instanceId] : {};
            const itemType = task?.itemType || defaults.itemType || 'task';
            const leftColumn = dom['left-modal-column'];

            // Populate Edit Column first
            dom['modal-title'].textContent = isEditing ? `Editar ${itemType === 'event' ? 'Evento' : 'Tarea'}` : `Añadir ${itemType === 'event' ? 'Evento' : 'Tarea'}`;
            dom['task-id'].value = taskId || '';
            dom['task-instance-id'].value = instanceId || '';
            dom['task-item-type'].value = itemType;
            dom['task-name'].value = task?.name || '';
            dom['task-priority'].value = task?.priority || 'Media';
            dom['task-type'].value = task?.type || 'Otro';
            dom['task-subject-category'].value = task?.subjectCategory || 'General';
            dom['task-color'].value = task?.color || '#8A5CF4';
            dom['task-notes'].value = task?.notes || '';
            dom['assign-start-hour'].value = instanceId ? event.startHour : (defaults.startHour || '');
            dom['assign-end-hour'].value = instanceId ? event.endHour : (defaults.endHour || '');
            dom['delete-task-btn'].style.display = isEditing ? 'inline-flex' : 'none';
            
            // Lógica de campos y secciones
            const subtaskSection = dom['subtask-section'];
            const scheduleSection = dom['schedule-section'];
            const categoryContainer = dom['category-field-container'];
            const typeContainer = dom['type-field-container'];
            
            // Reset left column
            leftColumn.innerHTML = '';

            if (itemType === 'task') {
                subtaskSection.classList.remove('hidden');
                scheduleSection.classList.add('hidden');
                categoryContainer.classList.remove('hidden');
                typeContainer.classList.add('hidden');
                dom['task-type'].value = 'Tarea';
                leftColumn.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-4">
                            <div id="view-task-color-bar" class="w-2 h-16 rounded-full" style="background-color: ${task?.color || '#8A5CF4'}"></div>
                            <div>
                                <h2 id="view-task-name" class="text-3xl font-bold">${task?.name || 'Nueva Tarea'}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="my-6 border-t border-gray-700"></div>
                    <div class="space-y-4 text-lg">
                        <div class="flex items-center gap-4"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span id="view-task-category">${task?.subjectCategory || 'General'}</span></div>
                        <div class="flex items-center gap-4"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h2zM7 13h10M7 17h5"></path></svg><span id="view-task-type">Tarea</span></div>
                        <div class="flex items-center gap-4"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg><span id="view-task-priority">${task?.priority || 'Media'}</span></div>
                        <div class="flex items-start gap-4"><svg class="w-6 h-6 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg><p id="view-task-notes" class="text-gray-300 whitespace-pre-wrap">${task?.notes || 'No hay notas.'}</p></div>
                    </div>
                `;
            } else { // event
                subtaskSection.classList.add('hidden');
                scheduleSection.classList.remove('hidden');
                categoryContainer.classList.remove('hidden');
                typeContainer.classList.remove('hidden');

                const sessionTopic = (instanceId && event.topic) ? event.topic : 'Agregar un título';
                const sessionNotes = (instanceId && event.sessionNotes) ? event.sessionNotes : 'Agregar algo de texto';

                leftColumn.innerHTML = `
                    <div id="notebook-viewer" class="flex flex-col h-full">
                        <div class="flex-shrink-0">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-4">
                                    <div class="w-2 h-16 rounded-full" style="background-color: ${task?.color || '#8A5CF4'}"></div>
                                    <div>
                                        <h2 class="text-3xl font-bold">${task?.name || 'Nuevo Evento'}</h2>
                                        <p class="text-gray-400 text-lg">${new Date((event?.date || defaults.date) + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} • ${event?.startHour || defaults.startHour} - ${event?.endHour || defaults.endHour}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="my-6 border-t border-gray-700"></div>
                            <div class="space-y-4 text-lg">
                                <div class="flex items-center gap-4"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg><span>${task?.subjectCategory || 'General'}</span></div>
                                <div class="flex items-center gap-4"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h2zM7 13h10M7 17h5"></path></svg><span>${task?.type || 'Clase'}</span></div>
                                <div class="flex items-center gap-4"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg><span>${task?.priority || 'Media'}</span></div>
                                <div class="flex items-start gap-4"><svg class="w-6 h-6 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7"></path></svg><p class="text-gray-300 whitespace-pre-wrap">${task?.notes || 'No hay notas.'}</p></div>
                            </div>
                            <div class="my-6 border-t border-gray-700"></div>
                        </div>

                        <div class="flex-grow flex flex-col min-h-0 relative">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">Cuaderno de la Sesión</h3>
                                <button type="button" id="fullscreen-notes-btn" class="icon-btn">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4 0l-5-5M4 16v4m0 0h4m-4 0l5-5m11 1v-4m0 0h-4m4 0l-5 5"></path></svg>
                                </button>
                            </div>
                            <input id="session-topic-input" type="text" class="notes-title-input mt-2" value="${sessionTopic}">
                            <textarea id="session-notes-editor" class="notes-editor mt-2 flex-grow" placeholder="Escribe tus notas aquí...">${sessionNotes}</textarea>
                        </div>
                    </div>
                `;

                const fullscreenBtn = dom['fullscreen-notes-btn'];
                fullscreenBtn.addEventListener('click', () => {
                    const editorContainer = dom['notebook-viewer'];
                    const isNowFullscreen = editorContainer.classList.toggle('fullscreen-editor');
                    if (isNowFullscreen) {
                        setTimeout(() => editorContainer.classList.add('fullscreen-active'), 10);
                    } else {
                        editorContainer.classList.remove('fullscreen-active');
                    }
                    editorContainer.classList.toggle('glassmorphism', isNowFullscreen);
                    document.body.style.overflow = isNowFullscreen ? 'hidden' : '';
                    if (isNowFullscreen) {
                        window.addEventListener('keydown', exitFullscreenOnEsc);
                    } else {
                        window.removeEventListener('keydown', exitFullscreenOnEsc);
                    }
                    function exitFullscreenOnEsc(e) {
                        if (e.key === 'Escape') {
                            editorContainer.classList.remove('fullscreen-active');
                            setTimeout(() => {
                                editorContainer.classList.remove('fullscreen-editor');
                                editorContainer.classList.remove('glassmorphism');
                                document.body.style.overflow = '';
                            }, 350);
                            window.removeEventListener('keydown', exitFullscreenOnEsc);
                        }
                    }
                });
            }

            dom['unified-modal'].classList.add('visible');
        }

        function renderSubtaskEditor(subtasks) {
            const editorList = dom['subtask-editor-list'];
            editorList.innerHTML = '';
            subtasks.forEach((subtask, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 bg-gray-900 p-2 rounded';
                div.innerHTML = `
                    <input type="checkbox" class="task-select-checkbox" ${subtask.completed ? 'checked' : ''} data-index="${index}">
                    <input type="text" class="form-input bg-transparent border-0 p-0 flex-grow" value="${subtask.name}" data-index="${index}">
                    <button type="button" class="text-red-500 hover:text-red-400" data-index="${index}">&times;</button>
                `;
                editorList.appendChild(div);
            });
        }
        
        function getSubtasksFromEditor() {
            const subtasks = [];
            dom['subtask-editor-list'].querySelectorAll('.flex').forEach(div => {
                const nameInput = div.querySelector('input[type="text"]');
                const completedCheckbox = div.querySelector('input[type="checkbox"]');
                if (nameInput.value) {
                    subtasks.push({
                        id: nameInput.dataset.id || generateId(),
                        name: nameInput.value,
                        completed: completedCheckbox.checked
                    });
                }
            });
            return subtasks;
        }

        function toggleSelectMode(type, forceOff = false) {
            isSelectModeActive = forceOff ? false : !isSelectModeActive;
            
            if (!isSelectModeActive) {
                selectedTaskIds.clear();
            }

            dom['task-actions'].classList.toggle('hidden', isSelectModeActive);
            dom['select-mode-actions-tasks'].classList.toggle('hidden', !isSelectModeActive);
            dom['event-actions'].classList.toggle('hidden', isSelectModeActive);
            dom['select-mode-actions-events'].classList.toggle('hidden', !isSelectModeActive);
            renderTasks();
        }

        function deleteSelectedItems() {
            if (selectedTaskIds.size === 0) {
                showToast('No hay elementos seleccionados', 'error');
                return;
            }
            
            const count = selectedTaskIds.size;
            tasks = tasks.filter(t => !selectedTaskIds.has(t.id));
            Object.keys(scheduledTasks).forEach(key => {
                if (selectedTaskIds.has(scheduledTasks[key].taskId)) {
                    delete scheduledTasks[key];
                }
            });
            
            showToast(`${count} elemento(s) eliminado(s)`, 'error');
            
            toggleSelectMode(null, true); 
            saveAndRender();
        }

        function selectAll(type) {
            const itemsToSelect = tasks.filter(t => t.itemType === type);
            const allSelected = itemsToSelect.every(item => selectedTaskIds.has(item.id));

            itemsToSelect.forEach(item => {
                if (allSelected) {
                    selectedTaskIds.delete(item.id);
                } else {
                    selectedTaskIds.add(item.id);
                }
            });
            renderTasks();
        }

        function downloadCalendar() {
            let icsFile = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//YourApp//EN\n';

            for (const instanceId in scheduledTasks) {
                const event = scheduledTasks[instanceId];
                const task = tasks.find(t => t.id === event.taskId);
                if (!task) continue;

                const startDate = new Date(`${event.date}T${event.startHour}`);
                const endDate = new Date(`${event.date}T${event.endHour}`);

                // Formato UTC: YYYYMMDDTHHMMSSZ
                const toUTC = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

                icsFile += 'BEGIN:VEVENT\n';
                icsFile += `UID:${instanceId}@yourapp.com\n`;
                icsFile += `DTSTAMP:${toUTC(new Date())}\n`;
                icsFile += `DTSTART:${toUTC(startDate)}\n`;
                icsFile += `DTEND:${toUTC(endDate)}\n`;
                icsFile += `SUMMARY:${task.name}\n`;
                icsFile += `DESCRIPTION:${task.notes || ''}\n`;
                icsFile += 'END:VEVENT\n';
            }

            icsFile += 'END:VCALENDAR';

            const blob = new Blob([icsFile], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "mi_calendario.ics");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadPDF() {
            showToast('Generando PDF...', 'success');
            const calendarEl = dom.calendar;
            const { jsPDF } = window.jspdf;

            html2canvas(calendarEl, {
                backgroundColor: '#1C1B22', // Match the theme
                scale: 2 // Higher resolution
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save('calendario.pdf');
                showToast('PDF Descargado', 'success');
            });
        }

        function renderStatistics() {
            // Stats Universitarias
            const universityTasks = tasks.filter(t => t.itemType === 'task');
            let pendingTaskCount = 0;
            let completedTaskCount = 0;
            universityTasks.forEach(task => {
                pendingTaskCount += (task.subtasks || []).filter(st => !st.completed).length;
                if (task.subtasks && task.subtasks.length > 0 && task.subtasks.every(st => st.completed)) {
                    completedTaskCount++;
                }
            });
            dom['stats-task-count'].textContent = pendingTaskCount;
            dom['stats-completed-tasks'].textContent = completedTaskCount;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const upcomingExams = Object.values(scheduledTasks)
                .map(event => ({ ...event, task: tasks.find(t => t.id === event.taskId) }))
                .filter(event => event.task && event.task.type === 'Examen' && new Date(event.date + 'T00:00:00') >= today)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (upcomingExams.length > 0) {
                const nextExamDate = new Date(upcomingExams[0].date + 'T00:00:00');
                const diffTime = Math.abs(nextExamDate - today);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                dom['stats-next-exam'].textContent = diffDays;
            } else {
                dom['stats-next-exam'].textContent = 'N/A';
            }

            // Stats Generales
            const totalEvents = tasks.filter(t => t.itemType === 'event').length;
            dom['stats-total-events'].textContent = totalEvents;

            const weekStart = getStartOfWeek(new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            const weekEvents = Object.values(scheduledTasks).filter(event => {
                const eventDate = new Date(event.date + 'T00:00:00');
                return eventDate >= weekStart && eventDate <= weekEnd;
            });
            dom['stats-week-events'].textContent = weekEvents.length;

            // Horas programadas y día más ocupado
            let weeklyHours = 0;
            const dayCounts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
            const dayNames = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];

            weekEvents.forEach(event => {
                const start = new Date(`1970-01-01T${event.startHour}`);
                const end = new Date(`1970-01-01T${event.endHour}`);
                const duration = (end - start) / (1000 * 60 * 60);
                weeklyHours += duration;
                
                const eventDay = new Date(event.date + 'T00:00:00').getDay();
                dayCounts[eventDay]++;
            });
            dom['stats-week-hours'].textContent = weeklyHours.toFixed(1);

            let busiestDayIndex = -1;
            let maxEvents = 0;
            for (const day in dayCounts) {
                if (dayCounts[day] > maxEvents) {
                    maxEvents = dayCounts[day];
                    busiestDayIndex = day;
                }
            }
            dom['stats-busiest-day'].textContent = busiestDayIndex !== -1 ? dayNames[busiestDayIndex] : 'N/A';

            // Materia con más carga
            const subjectHours = {};
            weekEvents.forEach(event => {
                const task = tasks.find(t => t.id === event.taskId);
                if (task && task.subjectCategory) {
                    const start = new Date(`1970-01-01T${event.startHour}`);
                    const end = new Date(`1970-01-01T${event.endHour}`);
                    const duration = (end - start) / (1000 * 60 * 60);
                    subjectHours[task.subjectCategory] = (subjectHours[task.subjectCategory] || 0) + duration;
                }
            });
            let busiestSubject = 'N/A';
            let maxHours = 0;
            for (const subject in subjectHours) {
                if (subjectHours[subject] > maxHours) {
                    maxHours = subjectHours[subject];
                    busiestSubject = subject;
                }
            }
            dom['stats-busiest-subject'].textContent = busiestSubject;
        }

        async function generateSubtasks() {
            const taskName = dom['task-name'].value;
            const taskCategory = dom['task-subject-category'].value;
            if (!taskName) {
                showToast('Por favor, introduce un nombre para la tarea.', 'error');
                return;
            }

            const btn = dom['generate-subtasks-btn'];
            btn.innerHTML = '...'; // Loading state
            btn.disabled = true;

            try {
                const prompt = `Basado en el título de la tarea "${taskName}" para la materia o categoría "${taskCategory}", genera una lista concisa de 3 a 5 subtareas accionables para completarla. Responde únicamente con un array JSON de strings. Por ejemplo: ["Investigar el tema", "Crear un borrador", "Diseñar diapositivas"]`;
                
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const text = result.candidates[0].content.parts[0].text;
                    const subtaskNames = JSON.parse(text);
                    const newSubtasks = subtaskNames.map(name => ({
                        id: generateId(),
                        name: name,
                        completed: false
                    }));
                    
                    const currentSubtasks = getSubtasksFromEditor();
                    renderSubtaskEditor([...currentSubtasks, ...newSubtasks]);
                } else {
                    throw new Error("No se recibieron sugerencias.");
                }

            } catch (error) {
                console.error("Error generating subtasks:", error);
                showToast('No se pudieron generar las subtareas.', 'error');
            } finally {
                btn.innerHTML = '✨';
                btn.disabled = false;
            }
        }


        // --- INICIALIZACIÓN Y GUARDADO ---
        function saveAndRender() {
            saveToStorage(STORAGE_KEYS.tasks, tasks);
            saveToStorage(STORAGE_KEYS.schedule, scheduledTasks);
            renderAll();
        }

        function renderAll() {
            renderTasks();
            renderCalendar();
            renderStatistics();
        }

        function init() {
            const closeModalBtns = document.querySelectorAll('.close-modal-btn');

            // Listeners de selección
            dom['select-tasks-btn'].addEventListener('click', () => toggleSelectMode('tasks'));
            dom['cancel-select-tasks-btn'].addEventListener('click', () => toggleSelectMode('tasks', true));
            dom['delete-selected-tasks-btn'].addEventListener('click', deleteSelectedItems);
            dom['select-all-tasks-btn'].addEventListener('click', () => selectAll('task'));

            dom['select-events-btn'].addEventListener('click', () => toggleSelectMode('events'));
            dom['cancel-select-events-btn'].addEventListener('click', () => toggleSelectMode('events', true));
            dom['delete-selected-events-btn'].addEventListener('click', deleteSelectedItems);
            dom['select-all-events-btn'].addEventListener('click', () => selectAll('event'));


            dom['detailed-add-task-btn'].addEventListener('click', () => dom['choice-modal'].classList.add('visible'));
            dom['create-task-btn'].addEventListener('click', () => { dom['choice-modal'].classList.remove('visible'); openUnifiedModal(null, null, { itemType: 'task' }); });
            dom['create-event-btn'].addEventListener('click', () => { dom['choice-modal'].classList.remove('visible'); openUnifiedModal(null, null, { itemType: 'event' }); });
            
            dom['quick-add-task-input'].addEventListener('keyup', e => {
                if (e.key === 'Enter' && dom['quick-add-task-input'].value.trim()) {
                    const newTask = { id: generateId(), itemType: 'task', name: dom['quick-add-task-input'].value.trim(), color: '#8A5CF4', subtasks: [] };
                    tasks.push(newTask);
                    dom['quick-add-task-input'].value = '';
                    saveAndRender();
                    showToast('Tarea rápida añadida');
                }
            });
            
            const setupViewButtons = () => {
                const btns = { day: dom['day-view-btn'], week: dom['week-view-btn'] };
                Object.values(btns).forEach(b => b.classList.remove('bg-purple-600', 'text-white'));
                if (btns[currentView]) {
                    btns[currentView].classList.add('bg-purple-600', 'text-white');
                }
            };
            dom['prev-week-btn'].addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() - (currentView === 'day' ? 1 : 7)); renderCalendar(); });
            dom['next-week-btn'].addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() + (currentView === 'day' ? 1 : 7)); renderCalendar(); });
            dom['day-view-btn'].addEventListener('click', () => { currentView = 'day'; renderCalendar(); setupViewButtons(); });
            dom['week-view-btn'].addEventListener('click', () => { currentView = 'week'; renderCalendar(); setupViewButtons(); });
            dom['go-to-today-btn'].addEventListener('click', () => { currentWeekStart = getStartOfWeek(new Date()); renderCalendar(); });
            window.addEventListener('resize', debounce(renderCalendar, 150));
            
            dom['add-subtask-btn'].addEventListener('click', () => {
                const nameInput = dom['new-subtask-name'];
                if (nameInput.value.trim()) {
                    const currentSubtasks = getSubtasksFromEditor();
                    currentSubtasks.push({ name: nameInput.value.trim(), completed: false });
                    renderSubtaskEditor(currentSubtasks);
                    nameInput.value = '';
                }
            });

            dom['generate-subtasks-btn'].addEventListener('click', generateSubtasks);

            dom['subtask-editor-list'].addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const index = e.target.dataset.index;
                    let currentSubtasks = getSubtasksFromEditor();
                    currentSubtasks.splice(index, 1);
                    renderSubtaskEditor(currentSubtasks);
                }
            });

            dom['task-form'].addEventListener('submit', e => {
                e.preventDefault();
                const id = dom['task-id'].value || generateId();
                const isUpdating = !!dom['task-id'].value;
                let task = isUpdating ? tasks.find(t => t.id === id) : { id };
                
                Object.assign(task, {
                    name: dom['task-name'].value,
                    priority: dom['task-priority'].value,
                    type: dom['task-type'].value,
                    subjectCategory: dom['task-subject-category'].value,
                    color: dom['task-color'].value,
                    notes: dom['task-notes'].value,
                    itemType: dom['task-item-type'].value
                });

                if (task.itemType === 'task') {
                    task.subtasks = getSubtasksFromEditor();
                } else if (task.type === 'Clase') {
                    const instanceId = dom['task-instance-id'].value;
                    if (instanceId && scheduledTasks[instanceId]) {
                        scheduledTasks[instanceId].topic = dom['session-topic-input'].value;
                        scheduledTasks[instanceId].sessionNotes = dom['session-notes-editor'].value;
                    }
                }

                if (!isUpdating) tasks.push(task);
                
                const startHour = dom['assign-start-hour'].value;
                const endHour = dom['assign-end-hour'].value;
                if (task.itemType === 'event' && startHour && endHour) {
                    const instanceId = dom['task-instance-id'].value || generateId();
                    scheduledTasks[instanceId] = {
                        ...scheduledTasks[instanceId],
                        taskId: id,
                        date: dom['new-event-date'].value,
                        startHour: startHour,
                        endHour: endHour
                    };
                }

                dom['unified-modal'].classList.remove('visible');
                saveAndRender();
                showToast(isUpdating ? 'Elemento actualizado' : 'Elemento creado');
            });
            
            dom['delete-task-btn'].addEventListener('click', () => {
                const id = dom['task-id'].value;
                tasks = tasks.filter(t => t.id !== id);
                Object.keys(scheduledTasks).forEach(key => {
                    if (scheduledTasks[key].taskId === id) delete scheduledTasks[key];
                });
                dom['unified-modal'].classList.remove('visible');
                saveAndRender();
                showToast('Elemento eliminado', 'error');
            });

            closeModalBtns.forEach(btn => btn.closest('.modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget || e.target.closest('.close-modal-btn')) {
                    e.currentTarget.classList.remove('visible');
                }
            }));

            // Tab switching
            dom['tasks-tab-btn'].addEventListener('click', () => {
                dom['tasks-tab-content'].classList.remove('hidden');
                dom['notebooks-tab-content'].classList.add('hidden');
                dom['bulk-add-tab-content'].classList.add('hidden');
                dom['tasks-tab-btn'].classList.add('border-purple-500', 'text-white').remove('border-transparent', 'text-gray-400');
                dom['notebooks-tab-btn'].classList.add('border-transparent', 'text-gray-400').remove('border-purple-500', 'text-white');
                dom['bulk-add-tab-btn'].classList.add('border-transparent', 'text-gray-400').remove('border-purple-500', 'text-white');
            });
            dom['notebooks-tab-btn'].addEventListener('click', () => {
                dom['tasks-tab-content'].classList.add('hidden');
                dom['notebooks-tab-content'].classList.remove('hidden');
                dom['bulk-add-tab-content'].classList.add('hidden');
                dom['notebooks-tab-btn'].classList.add('border-purple-500', 'text-white').remove('border-transparent', 'text-gray-400');
                dom['tasks-tab-btn'].classList.add('border-transparent', 'text-gray-400').remove('border-purple-500', 'text-white');
                dom['bulk-add-tab-btn'].classList.add('border-transparent', 'text-gray-400').remove('border-purple-500', 'text-white');
                renderNotebooks();
            });
            dom['bulk-add-tab-btn'].addEventListener('click', () => {
                dom['tasks-tab-content'].classList.add('hidden');
                dom['notebooks-tab-content'].classList.add('hidden');
                dom['bulk-add-tab-content'].classList.remove('hidden');
                dom['bulk-add-tab-btn'].classList.add('border-purple-500', 'text-white').remove('border-transparent', 'text-gray-400');
                dom['tasks-tab-btn'].classList.add('border-transparent', 'text-gray-400').remove('border-purple-500', 'text-white');
                dom['notebooks-tab-btn'].classList.add('border-transparent', 'text-gray-400').remove('border-purple-500', 'text-white');
            });

            // Bulk add logic
            dom['add-bulk-btn'].addEventListener('click', () => {
                const jsonInput = dom['bulk-json-input'].value;
                try {
                    const bulkData = JSON.parse(jsonInput);
                    if (!Array.isArray(bulkData)) {
                        throw new Error("El JSON debe ser un array de tareas/eventos.");
                    }

                    let itemsAdded = 0;
                    bulkData.forEach(itemData => {
                        if (!itemData.name) return;

                        if (!itemData.itemType) {
                            itemData.itemType = (itemData.type === 'Clase') ? 'event' : 'task';
                        }

                        const newItem = {
                            id: generateId(),
                            name: itemData.name,
                            itemType: itemData.itemType,
                            priority: itemData.priority || 'Media',
                            type: itemData.type || 'Otro',
                            subjectCategory: itemData.subjectCategory || 'General',
                            color: itemData.color || '#8A5CF4',
                            notes: itemData.notes || '',
                            subtasks: itemData.itemType === 'task' ? (itemData.subtasks || []) : undefined
                        };
                        
                        if (Array.isArray(itemData.events)) {
                            itemData.events.forEach(eventData => {
                                if(!eventData.date || !eventData.startHour || !eventData.endHour) return;

                                if (eventData.isRecurrent && Array.isArray(eventData.repeatOn) && eventData.repeatUntil) {
                                    let currentDate = new Date(eventData.date + 'T00:00:00');
                                    const endDate = new Date(eventData.repeatUntil + 'T00:00:00');
                                    
                                    while (currentDate <= endDate) {
                                        if (eventData.repeatOn.includes(currentDate.getDay())) {
                                            scheduledTasks[generateId()] = {
                                                taskId: newItem.id,
                                                date: currentDate.toISOString().slice(0, 10),
                                                startHour: eventData.startHour,
                                                endHour: eventData.endHour
                                            };
                                        }
                                        currentDate.setDate(currentDate.getDate() + 1);
                                    }
                                } else {
                                    scheduledTasks[generateId()] = { 
                                        taskId: newItem.id, 
                                        date: eventData.date, 
                                        startHour: eventData.startHour, 
                                        endHour: eventData.endHour 
                                    };
                                }
                            });
                        }
                        tasks.push(newItem);
                        itemsAdded++;
                    });

                    saveAndRender();
                    showToast(`${itemsAdded} elemento(s) añadido(s) correctamente.`);
                    dom['bulk-json-input'].value = '';
                    dom['tasks-tab-btn'].click();

                } catch (error) {
                    showToast(`Error en el formato JSON: ${error.message}`, 'error');
                }
            });
            
            const options = {
                priority: ['Baja', 'Media', 'Alta'],
                type: ['Otro', 'Clase', 'Tarea', 'Lectura', 'Examen', 'Personal'],
                subjectCategory: ['General', 'Cálculo', 'Programación', 'Historia', 'Arte', 'Deportes'],
                time: Array.from({length:36}, (_,i) => `${String(Math.floor(6+i/2)).padStart(2,'0')}:${String((i%2)*30).padStart(2,'0')}`)
            };
            const populate = (sel, opts, def) => { sel.innerHTML = `<option value="">${def}</option>` + opts.map(o => `<option value="${o}">${o}</option>`).join(''); };
            populate(dom['task-priority'], options.priority, 'Prioridad');
            populate(dom['task-type'], options.type, 'Tipo');
            populate(dom['task-subject-category'], options.subjectCategory, 'Categoría');
            populate(dom['assign-start-hour'], options.time, 'Inicio');
            populate(dom['assign-end-hour'], options.time, 'Fin');

            // Listeners para popovers de ordenamiento y descarga
            ['tasks', 'events'].forEach(type => {
                const btn = dom[`sort-${type}-btn`];
                const popover = dom[`sort-${type}-popover`];
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    popover.style.display = popover.style.display === 'block' ? 'none' : 'block';
                });
                popover.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        if (type === 'tasks') {
                            taskSortOrder = e.target.dataset.sort;
                        } else {
                            eventSortOrder = e.target.dataset.sort;
                        }
                        renderTasks();
                        popover.style.display = 'none';
                    }
                });
            });

            const downloadBtn = dom['download-calendar-btn'];
            const downloadPopover = dom['download-popover'];
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                downloadPopover.style.display = downloadPopover.style.display === 'block' ? 'none' : 'block';
            });
            dom['download-ics-btn'].addEventListener('click', () => {
                downloadCalendar();
                downloadPopover.style.display = 'none';
            });
            dom['download-pdf-btn'].addEventListener('click', () => {
                downloadPDF();
                downloadPopover.style.display = 'none';
            });

            document.addEventListener('click', () => {
                dom['sort-tasks-popover'].style.display = 'none';
                dom['sort-events-popover'].style.display = 'none';
                dom['download-popover'].style.display = 'none';
            });

            // Listeners para drag and drop de listas
            dom['task-list-tareas'].addEventListener('dragover', (e) => e.preventDefault());
            dom['task-list-eventos'].addEventListener('dragover', (e) => e.preventDefault());
            dom['task-list-tareas'].addEventListener('drop', (e) => handleListDrop(e, 'task'));
            dom['task-list-eventos'].addEventListener('drop', (e) => handleListDrop(e, 'event'));

            setupViewButtons();
            renderAll();
            setInterval(renderCurrentTimeIndicator, 60000);
        }
        
        init();
    });
    </script>
</body>
</html>